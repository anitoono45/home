<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anitoono</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Anitoono Theme (Red and Black) */
        body {
            background-color: #0f172a; /* Slightly darker background */
            color: #e2e8f0; /* Lighter text for better contrast */
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            color: #f87171; /* Lighter red for headings */
        }

        .text-red-500 {
            color: #ef4444; /* Standard Red color from Tailwind */
        }
        .bg-red-500 {
            background-color: #ef4444; /* Standard Red background from Tailwind */
        }
        .hover\:bg-red-600:hover {
            background-color: #dc2626; /* Darker red hover effect */
        }
        .bg-gray-800 {
            background-color: #1e293b; /* Dark gray background */
        }
         .bg-gray-700 {
            background-color: #334155; /* Medium gray background */
        }
        .border-red-500 {
            border-color: #ef4444; /* Red border */
        }
        .focus\:ring-red-500:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5); /* Red focus ring */
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .4; }
        }

        /* Mobile-friendly adjustments */
        .container {
            max-width: 100%; /* Ensure container takes full width on small screens */
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .avatar-option.selected {
            border-color: #ef4444; /* Red border for selected avatar */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.7); /* Enhanced shadow for selection */
        }
         .avatar-option:hover {
            transform: scale(1.1); /* Slightly enlarge on hover */
             transition: transform 0.2s ease-in-out;
        }

        /* Profile Dropdown Styles - NEW DESIGN */
        #user-profile {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem; /* Add padding for larger click area */
            border-radius: 0.375rem; /* Rounded corners */
            transition: background-color 0.2s ease;
        }
         #user-profile:hover {
            background-color: #334155; /* Medium gray background on hover */
        }

        #profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #334155; /* Medium gray background */
            border: none; /* No border */
            border-radius: 0.5rem; /* More rounded corners */
            padding: 0.5rem 0; /* Adjusted padding */
            margin-top: 0.75rem; /* Increased margin */
            min-width: 200px; /* Increased min-width */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); /* Deeper shadow */
            z-index: 10;
            display: none; /* Initially hidden */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
             overflow: hidden; /* Ensure rounded corners are visible */
        }
        #profile-dropdown.show {
            display: block; /* Show when the show class is added */
            opacity: 1;
            transform: translateY(0);
        }
        #profile-dropdown a {
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center; /* Vertically align items */
            padding: 0.75rem 1.5rem; /* Increased padding */
            color: #cbd5e1; /* Light gray text */
            text-decoration: none;
            transition: color 0.2s ease, background-color 0.2s ease;
            font-size: 1rem; /* Slightly larger font */
             /* No border between items in this design */
        }

        #profile-dropdown a i {
             margin-right: 1rem; /* More space between icon and text */
             width: 1.2rem; /* Fixed width for icons */
             text-align: center; /* Center icon */
             color: #f87171; /* Red color for icons */
        }
        #profile-dropdown a:hover {
            color: #f9fafb; /* White text on hover */
            background-color: #475569; /* Darker gray background on hover */
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.95); /* Darker background with more opacity */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Ensure modals are on top */
            overflow-y: auto; /* Allow scrolling for tall modals */
            padding: 1rem; /* Add padding for mobile */
        }

        .modal-content {
            background-color: #1e293b; /* bg-gray-800 */
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.6); /* Deeper shadow */
            padding: 2.5rem; /* Increased padding */
            width: 100%;
            max-width: 32rem; /* Increased max-width */
            position: relative; /* Needed for close button positioning */
            animation: fadeInScale 0.3s ease-out; /* Add modal entry animation */
        }

         @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .modal-close-button {
            position: absolute;
            top: 1.25rem; /* Adjusted position */
            right: 1.25rem; /* Adjusted position */
            font-size: 1.75rem; /* Larger close icon */
            color: #94a3b8; /* Light gray color */
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #f1f5f9; /* Lighter gray on hover */
        }

        /* Icon Styles */
        .auth-icon {
            width: 28px; /* Adjust size as needed */
            height: 28px; /* Adjust size as needed */
            color: #cbd5e1; /* Light gray color */
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .auth-icon:hover {
            color: #f1f5f9; /* Lighter gray on hover */
        }

         /* History List Styles */
        #history-list {
            list-style: none;
            padding: 0;
        }
        #history-list li {
            background-color: #334155; /* Medium gray */
            padding: 1rem 1.25rem; /* Increased padding */
            margin-bottom: 0.75rem; /* Increased margin */
            border-radius: 0.375rem; /* Rounded corners */
            font-size: 1rem; /* Slightly larger font */
            color: #cbd5e1; /* Light gray text */
            word-break: break-word; /* Prevent long titles from overflowing */
            border-left: 4px solid #ef4444; /* Red accent border */
            transition: background-color 0.2s ease;
        }
         #history-list li:hover {
            background-color: #475569; /* Darker gray on hover */
        }
         #history-list li:last-child {
            margin-bottom: 0;
        }

        /* Notification Button Styling */
        #notification-button {
            background: none;
            border: none;
            color: #cbd5e1; /* Light gray */
            cursor: pointer;
            padding: 0.5rem; /* Add padding */
            font-size: 1.5rem; /* Larger icon */
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* Rounded corners */
             transition: background-color 0.2s ease;
        }

        #notification-button:hover {
            color: #f1f5f9; /* Lighter gray on hover */
             background-color: #334155; /* Medium gray background on hover */
        }

        /* Notification List Styling */
        #notification-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem; /* Increased margin */
        }

        #notification-list li {
            background-color: #334155; /* Medium gray */
            padding: 1rem 1.25rem; /* Increased padding */
            margin-bottom: 0.75rem; /* Increased margin */
            border-radius: 0.375rem; /* Rounded corners */
            font-size: 0.95rem; /* Slightly larger font */
            color: #cbd5e1; /* Light gray text */
             border-left: 4px solid #f87171; /* Lighter red accent */
             transition: background-color 0.2s ease;
        }
         #notification-list li:hover {
             background-color: #475569; /* Darker gray on hover */
         }

        #notification-list li:last-child {
            margin-bottom: 0;
        }

        /* Loading Screen Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f172a; /* Same as body background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99; /* High z-index to cover everything */
            transition: opacity 0.5s ease-in-out;
        }

        .loading-avatar-container {
            position: relative;
            width: 100px; /* Larger avatar container */
            height: 100px;
            margin-bottom: 1.5rem; /* Increased margin */
        }

        #loading-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #334155; /* Thicker border around avatar */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); /* Red glow effect */
        }

        .loading-spinner {
            position: absolute;
            top: -15px; /* Position further outside the avatar */
            left: -15px;
            width: 130px; /* Larger spinner */
            height: 130px;
            border: 8px solid rgba(239, 68, 68, 0.2); /* Red with opacity */
            border-top-color: #ef4444; /* Solid red for the spinner part */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-username {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #f1f5f9; /* Lighter white */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); /* Add text shadow */
        }

        /* Hide main content initially */
        #main-content {
            display: none;
        }

        /* Post Card Styling - Modified for Portrait */
        .post-card {
            background-color: #1e293b; /* Dark gray background */
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            overflow: hidden;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column; /* Stack image and content */
            width: 100%; /* Ensure it takes full column width */
        }

        .post-card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6); /* Stronger shadow on hover */
        }

        .post-card img {
            width: 100%;
            height: 250px; /* Decreased height for smaller portrait */
            object-fit: cover; /* Cover the area without distortion */
            transition: transform 0.3s ease-in-out;
        }

         .post-card:hover img {
            transform: scale(1.05); /* Slightly zoom image on hover */
         }

        .post-card-content {
            padding: 1.25rem; /* Increased padding */
            flex-grow: 1; /* Allow content to take available space */
            display: flex;
            flex-direction: column;
        }

        .post-card-content h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #f87171; /* Lighter red */
            margin-bottom: 0.5rem;
             overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent wrapping */
        }

        .post-card-content p {
            font-size: 0.95rem; /* Slightly larger text */
            color: #cbd5e1; /* Light gray */
            flex-grow: 1; /* Allow description to take space */
             display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Skeleton Screen Styles */
        .post-card.skeleton {
            pointer-events: none; /* Disable clicks during skeleton state */
        }

        .post-card.skeleton img,
        .post-card.skeleton .post-card-content h3,
        .post-card.skeleton .post-card-content p {
            background-color: #334155; /* Medium gray placeholder background */
            color: transparent; /* Hide text */
            border-radius: 4px; /* Rounded corners for placeholders */
            animation: pulse 1.5s infinite ease-in-out; /* Apply pulse animation */
        }

        .post-card.skeleton img {
             /* Maintain image dimensions during skeleton state */
            height: 250px;
            width: 100%;
        }

        .post-card.skeleton .post-card-content h3 {
            height: 1.5rem; /* Placeholder height for title */
            width: 80%; /* Placeholder width for title */
            margin-bottom: 0.5rem;
        }

        .post-card.skeleton .post-card-content p {
            height: 3.5rem; /* Placeholder height for description (approx 3 lines) */
            width: 95%; /* Placeholder width for description */
        }

         /* Remove skeleton styles when not in skeleton state */
         .post-card:not(.skeleton) img {
            background-color: transparent;
            animation: none;
         }
         .post-card:not(.skeleton) .post-card-content h3,
         .post-card:not(.skeleton) .post-card-content p {
            background-color: transparent;
            color: #f87171; /* Restore title color */
            color: #cbd5e1; /* Restore description color */
            animation: none;
         }


        /* Form Input Styling */
        .form-input {
             background-color: #334155; /* Medium gray */
            border: 1px solid #475569; /* Darker gray border */
            color: #f1f5f9; /* Lighter text */
            padding: 0.75rem 1rem; /* Increased padding */
            border-radius: 0.375rem; /* Rounded corners */
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #ef4444; /* Red border on focus */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3); /* Red glow on focus */
        }

        /* Button Styling */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem; /* Increased padding */
            font-weight: 600; /* font-semibold */
            text-align: center;
            border-radius: 0.375rem; /* Rounded corners */
            transition: background-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #ef4444; /* Red */
            color: #f9fafb; /* White */
        }

        .btn-primary:hover {
            background-color: #dc2626; /* Darker red on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }

         .btn-secondary {
            background-color: #475569; /* Darker gray */
            color: #cbd5e1; /* Light gray */
         }

         .btn-secondary:hover {
            background-color: #334155; /* Medium gray on hover */
             transform: translateY(-1px); /* Slight lift on hover */
         }

         .btn:active {
            transform: translateY(0); /* Reset lift on click */
         }

        /* Link Styling */
        a {
            color: #f87171; /* Lighter red for links */
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: #ef4444; /* Standard red on hover */
            text-decoration: underline;
        }

         /* Message Box Styling (for errors/success) */
         .message-box {
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            text-align: center;
         }

         .message-box.error {
            background-color: #fee2e2; /* Red background */
            color: #b91c1c; /* Dark red text */
            border: 1px solid #ef4444; /* Red border */
         }

         .message-box.success {
            background-color: #d1fae5; /* Green background */
            color: #065f46; /* Dark green text */
            border: 1px solid #10b981; /* Green border */
         }

         /* Switch Account Modal Styles */
        #switch-account-modal {
            position: fixed;
            bottom: 0; /* Start from the bottom */
            left: 0;
            width: 100%;
            height: auto; /* Adjust height based on content */
            max-height: 80%; /* Limit max height */
            background-color: #1e293b; /* Dark gray background */
            border-top-left-radius: 1rem; /* Rounded top corners */
            border-top-right-radius: 1rem;
            box-shadow: 0 -8px 16px rgba(0, 0, 0, 0.5); /* Shadow at the top */
            z-index: 60; /* Higher than other modals */
            display: flex;
            flex-direction: column;
            transform: translateY(100%); /* Initially hidden below the screen */
            transition: transform 0.3s ease-out;
            overflow-y: auto; /* Allow scrolling if content exceeds max height */
        }

        #switch-account-modal.show {
            transform: translateY(0); /* Slide up into view */
        }

        #switch-account-modal .modal-content {
             /* Override some modal-content styles for the bottom sheet */
            background-color: transparent; /* No background color */
            box-shadow: none; /* No shadow */
            padding: 1.5rem; /* Adjusted padding */
            max-width: none; /* No max width */
            border-radius: 0; /* No border radius */
            animation: none; /* No entry animation */
        }

        #switch-account-modal .modal-close-button {
            position: static; /* Remove absolute positioning */
            align-self: flex-end; /* Align to the right */
            margin-bottom: 1rem; /* Add space below */
        }

        .account-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: #334155; /* Medium gray */
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .account-option:hover {
            background-color: #475569; /* Darker gray on hover */
        }

         .account-option.selected-account {
            border: 2px solid #ef4444; /* Red border for selected account */
            background-color: #1e293b; /* Darker background for selected */
         }

         .account-option.switching {
             opacity: 0.7; /* Dim slightly during switching */
             pointer-events: none; /* Disable clicks during switching */
         }

        .account-option img {
            width: 40px; /* Avatar size */
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
            border: 2px solid #ef4444; /* Red border */
        }

        .account-option span {
            font-size: 1.1rem;
            color: #f1f5f9; /* Lighter text */
            font-weight: 500;
             flex-grow: 1; /* Allow username to take space */
        }

        .account-option .loading-text {
             font-size: 0.9rem;
             color: #f87171; /* Lighter red */
             margin-left: 1rem;
        }

        /* Scroll to Top Button */
        #scroll-to-top-btn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 20px; /* 20px from the bottom */
            right: 20px; /* 20px from the right */
            z-index: 90; /* High z-index */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: #ef4444; /* Red background */
            color: white; /* White text/icon */
            cursor: pointer; /* Add a mouse pointer on hover */
            width: 50px; /* Set a fixed width */
            height: 50px; /* Set a fixed height */
            border-radius: 50%; /* Make it perfectly round */
            font-size: 18px; /* Increase font size */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Add shadow */
            transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.2s ease; /* Smooth transition */
             opacity: 0.7; /* Slightly transparent when not hovered */
             display: flex; /* Use flexbox to center the icon */
             justify-content: center; /* Center horizontally */
             align-items: center; /* Center vertically */
        }

        #scroll-to-top-btn:hover {
            background-color: #dc2626; /* Darker red on hover */
             opacity: 1; /* Full opacity on hover */
             transform: translateY(-2px); /* Slight lift effect */
        }
         #scroll-to-top-btn:active {
             transform: translateY(0); /* Reset lift on click */
         }


    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-overlay">
        <div class="loading-avatar-container">
            <img id="loading-avatar-img" src="" alt="Loading Avatar">
            <div class="loading-spinner"></div>
        </div>
        <span id="loading-username" class="mt-2"></span>
    </div>

    <div id="main-content">
        <header class="bg-gray-800 py-4 flex justify-between items-center shadow-md sticky top-0 z-10 rounded-md">
            <div class="logo text-red-500 text-2xl font-semibold ml-4">Anitoono</div>
            <div class="mr-4 flex items-center space-x-4">
                 <button id="notification-button">
                     <i class="fas fa-bell"></i> </button>
                <div id="login-icon" class="auth-icon hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                </div>
                <div id="user-profile" class="hidden">
                    <img id="avatar-img" src="" alt="Avatar" class="w-9 h-9 rounded-full mr-2 border-2 border-red-500">
                    <span id="username" class="text-gray-300 font-semibold"></span>
                     <div id="profile-dropdown" class="hidden">
                        <a href="#" id="add-account-link" class="hidden">
                            <i class="fas fa-user-plus"></i> Add Account
                        </a>
                        <a href="#" id="switch-account-link" class="hidden">
                             <i class="fas fa-users"></i> Switch Account
                        </a>
                        <a href="#" id="history-link">
                            <i class="fas fa-history"></i> History
                        </a>
                        <a href="#" id="settings-link">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <a href="#" id="reset-passcode-link">
                            <i class="fas fa-key"></i> Reset Passcode
                        </a>
                        <a href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto mt-8 p-4">
            <div id="search-container" class="mb-8 flex justify-center">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search for anime..."
                    class="form-input w-full md:w-2/3 lg:w-1/2"
                />
            </div>

            <div id="post-container" class="grid grid-cols-2 gap-4">
                </div>
        </main>
    </div>


    <div id="login-modal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeModal('login-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Login to Anitoono</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="login-email" class="form-input" required>
                    <div id="login-email-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="login-password" class="form-input" required>
                    <div id="login-password-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Login</button>
            </form>
            <div class="mt-6 text-center text-gray-400">
                <p>Don't have an account? <a href="#" id="switch-to-signup" class="text-red-500 hover:underline">Sign Up</a></p>
            </div>
        </div>
    </div>

    <div id="signup-modal" class="modal hidden">
        <div class="modal-content">
             <span class="modal-close-button" onclick="closeModal('signup-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Sign Up for Anitoono</h2>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="signup-email" class="form-input" required>
                    <div id="signup-email-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-username" class="block text-gray-300 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="signup-username" class="form-input" required>
                     <div id="signup-username-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="signup-password" class="form-input" required>
                    <div id="signup-password-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-avatar" class="block text-gray-300 text-sm font-bold mb-2">Choose Avatar:</label>
                    <div class="flex flex-wrap gap-3" id="avatar-options-container">
                        </div>
                    <input type="hidden" id="signup-avatar" name="signup-avatar" value="">
                    <div id="signup-avatar-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Sign Up</button>
            </form>
            <div class="mt-6 text-center text-gray-400">
                <p>Already have an account? <a href="#" id="switch-to-login" class="text-red-500 hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <div id="post-details-modal" class="modal hidden">
        <div class="modal-content max-w-2xl">
             <span class="modal-close-button" onclick="closeModal('post-details-modal')">&times;</span>
            <h2 id="post-details-title" class="text-2xl font-semibold mb-4 text-red-500"></h2>
            <div id="post-details-content" class="text-gray-300 mb-6"></div>
            <button onclick="closeModal('post-details-modal')" class="btn btn-secondary w-full">Close</button>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
             <span class="modal-close-button" onclick="closeModal('settings-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Settings</h2>
            <div class="space-y-6">
                 <div>
                    <label for="change-username" class="block text-gray-300 text-sm font-bold mb-2">Change Username:</label>
                    <input type="text" id="change-username" class="form-input">
                    <div id="change-username-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button id="save-username-btn" class="btn btn-primary w-full">Save Username</button>

                <div>
                    <label for="change-avatar" class="block text-gray-300 text-sm font-bold mb-2">Change Avatar:</label>
                     <div class="flex flex-wrap gap-3" id="settings-avatar-options-container">
                        </div>
                    <input type="hidden" id="settings-avatar" name="settings-avatar" value="">
                    <div id="settings-avatar-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>

                <button onclick="closeModal('settings-modal')" class="btn btn-secondary w-full">Close</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal hidden">
        <div class="modal-content max-w-lg">
             <span class="modal-close-button" onclick="closeModal('history-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Viewing History</h2>
            <ul id="history-list" class="mb-6">
                </ul>
             <button id="clear-history-btn-history-modal" class="btn btn-primary w-full mb-4">Clear History</button>
            <button onclick="closeModal('history-modal')" class="btn btn-secondary w-full">Close</button>
             <div id="history-message" class="text-center mt-4 text-green-500" style="display: none;"></div> </div>
    </div>

    <div id="notification-modal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <span class="modal-close-button" onclick="closeModal('notification-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Notifications</h2>
            <ul id="notification-list" class="space-y-4">
                 <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    New episode of "Awesome Anime" is available!
                </li>
                <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    Your favorite show "Cool Series" updated.
                </li>
                <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    Welcome to Anitoono!
                </li>
            </ul>
            <button onclick="closeModal('notification-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        </div>
    </div>


    <div id="reset-passcode-modal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeModal('reset-passcode-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Reset Passcode</h2>
            <form id="reset-passcode-form" class="space-y-6">
                 <div>
                    <label for="current-passcode" class="block text-gray-300 text-sm font-bold mb-2">Current Passcode:</label>
                    <input type="password" id="current-passcode" class="form-input" required>
                    <div id="current-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="new-passcode" class="block text-gray-300 text-sm font-bold mb-2">New Passcode:</label>
                    <input type="password" id="new-passcode" class="form-input" required>
                    <div id="new-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                 <div>
                    <label for="confirm-new-passcode" class="block text-gray-300 text-sm font-bold mb-2">Confirm New Passcode:</label>
                    <input type="password" id="confirm-new-passcode" class="form-input" required>
                    <div id="confirm-new-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Reset Passcode</button>
            </form>
        </div>
    </div>

     <div id="switch-account-modal" class="hidden">
        <div class="modal-content">
             <span class="modal-close-button" onclick="closeModal('switch-account-modal')">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Switch Account</h2>
            <div id="account-list" class="space-y-4">
                </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">
        <i class="fas fa-arrow-up"></i>
    </button>


    <script>
        // Data for initial posts (before search)
        const initialPosts = [
                        { id: 1, title: "Super Mario Bros Movie", content: "click to watch", imageUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0ZJ6mD8c41yfKCkzMB31PjOc4lQAHsjBtPblEk8rgFZEKA55VOrvPLaB7Xu7n9NQmvq9H4AMSCMTSE4w6K0DYegjEluUG8aXeNgf3DQEtGga8kbesrTn58botILFHXORCDCEIN7Ar8Q1jn0FDNrOw_orbasxl6jyZE1l9BvDJQO9Mnb3Ae0aut25qCAji/s320/images%20(16).jpeg", url: "https://anitoono45.github.io/super-mario-bros/" },
            { id: 2, title: "The glassworker", content: "click to watch.", imageUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjIUXm_1t8BPBw1giZXIo-ng9wBEWN1sqEUmWBJAb6pgNaR3foGxYsMwOEhV5bfZ01wlB6nRPqOl6A06lmy1VE3BaGVM8QTUotS2fc3ol_dI8XYfCu9BRxYCcDFf0_a-5IujAMnzmvayUeuCNwRVcg6Fx3XwgbTJo5CXiXp2B9yBmZip2vymSkQjIGdeizN/s320/images%20(17).jpeg", url: "https://anitoono45.github.io/The-glassworker/" },
            { id: 3, title: "Anime Title 3", content: "Anime description 3.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+3", url: "watch.html?id=3" },
            { id: 4, title: "Anime Title 4", content: "Anime description 4.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+4", url: "watch.html?id=4" },
            { id: 5, title: "Anime Title 5", content: "Anime description 5.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+5", url: "watch.html?id=5" },
            { id: 6, title: "Anime Title 6", content: "Anime description 6.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+6", url: "watch.html?id=6" },
            { id: 7, title: "Anime Title 7", content: "Anime description 7.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+7", url: "watch.html?id=7" },
            { id: 8, title: "Anime Title 8", content: "Anime description 8.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+8", url: "watch.html?id=8" },
            { id: 9, title: "Anime Title 9", content: "Anime description 9.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+9", url: "watch.html?id=9" },
            { id: 10, title: "Anime Title 10", content: "Anime description 10.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+10", url: "watch.html?id=10" },
            // Add your new posts here, like this:
            // { id: 11, title: "New Anime Title 1", content: "Description for new anime.", imageUrl: "URL_OF_YOUR_IMAGE", url: "watch.html?id=11" },
            // { id: 12, title: "New Anime Title 2", content: "Another great show.", imageUrl: "URL_OF_ANOTHER_IMAGE", url: "watch.html?id=12" },
        ];

        const avatarImages = [
                                              "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_ca_A9wrVuMNYNAdMBEAmVr38Yjmag2WlX0UUf5N_WxpNAGw4qb9dNUfCxLwM1rBM0l1QOxUmETHQAdqiOHFfUEQMg9aXBIthMj7K1AA8s4Tz9iW6n4jTLJ9rA_BgmJjWLljrdzH5QBlrhILastYFv-xqUGaX2Qb3tGZlSUDu9KIkqoTukabVotXeerZB/s320/images%20(12).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjXN0Bpdhj1_h9DlhuWzNEe3YTNtlszbxSmVPJW_r6qgd7gayt8DFCct7Sx8DgwAbcWv1jJc2LpB1HbcpnUrjAUHbqYZQwVlBiyACPWRqmmiej278Qi30ohOejsqUmntWcanAy26k6McmKMRrqIjpq3KpakAJsaY3Jh29zMnoqzgEf0sBk8NuvdDzWdGT_/s320/images%20(11).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLywX0IbfA4QLd_SuOlEfXVoS0b-cCfC7GlTRmVdPFAEzAiqa3tA56ncL-oO_9D1RyY-E7LBNetKRv7QyFXrOUOPnAnONhjzUlfxeSmWyXIyKvu91MrgCeUjn-wW6UuoA6QNU05HHmzGp9lnHFhBYmFR4UOASEcdqiyQs3_5dHLbR9I5wfRGGB9VZoEvxw/s320/images%20(2).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2jwXiTITDNaryWwfg6M9dsQgVubEmdnB7YMCINoo3x461EsIsld575Gd58fcKCqvc-cSefLtfv3nicIEoUFKRshcAjB07SuKx6POHk5aXkjcqZ2YzQDAmB_NXoBDEJQbHcmJOS6gBPc2oNGq9DRegcXKyX1hTs7PlN___6djPc90CADsXu4CoWjmDjnDX/s320/images%20(4).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaHQZq0-mmCLhwBksZgdP2f4kvb9dhAZQnj18Ybp44gSyuFvBh_s5CqOjknay3J6zqA8mSbPEPHFhF3BXG_nJRC5Rm2lGbhnDlhU2yZ8Zpm7VJa7msj02OxO5nViuX4yryhwklae-z1kB-w77uFzqXYIDtRx-QYNxeFFJbb6C9PErjTsLW0_OXCyTJV6Vp/s320/images%20(5).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLTZ4ZG3T2qklL16G4WRTFB3BFGN-B5dJViu3UhurzaVqdGueXdeHRevqy6jN5iKDZsxnGpWyjIiRvCbEaX9z3NXbWgxPlOAwl0i7_ZPeQ4GE5iuJBT8yhXjbOmRUnFJ-KXBk2kjRgNBXZDZct9lJUrVdunTW661fbWaEAm4AINsda_jaVgKyEFxYdLlyD/s320/images%20(6).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgj8BQrcI51_OMaNoAGctizntzxqFOnQ5rMrc7nnGcjPvYQFvvCAUK6Kj2UgPwT-JoraIiLylOV6YUhwY_ntMiUw9DbcWDNni5SQrdY5SdhjneuGISPF65zZrePrqQ2YKF5LpFkWjrnnK1sjmo31Y-Y0zzJt7vds5wW7bdNtSoeqfFFqOVTwx8A-Zz-tuaW/s320/images%20(7).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhMgph7LCDPbAosa6RR0YKqE59bdCCX94_wjHCNwPAPENrKLcEgJQRUyUoj9baUZVNPzhtW8MF4E61MyhU9Q0Bx-9UI57iLYCnfgxVIcM7tKCRmkYlaOKgMVs8J4Sc2IMx9XGyhjv6pietuw8rAnr1y6SjQ9xjwnhc_XSOyDY_dct1NgvZFCRkF2q0F_RQ_/s320/images%20(8).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2Vo2WUIjen2aktqxxIhzeFpgII5MEKvZPuzDJBxMeyHrwQzAS615EV-MdV7dcmhyphenhyphenT_9n7hVS6xPTf2PjrPWbySLt7EhDAvcXOVn8WCWU9FZ6vo-hpYzTzIR5LZVGKPmnLmuSJsDZIM9aKkkTmno0B9h-_n8smRp_Wj-DA1dWW3YFNbN7omXDHEJqW97DC/s320/images%20(9).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEDKdFKhlfGAInoUdFLTdpRZ5OGxi27Vnb_Na4cSB7E86N_AuMOnQbXNel0V4WR7gNauEmzISn6fsn8iLumyv1IHOB3Mnz7UAckriREfy5tmEaFQkLQr62muQHf-hOpj-LtjLbpP1Z9O6vbOZM09xT6Yry0KtojLHcOVIU_KzGhxUm4zbiyf65rB0Ecoav/s320/images%20(10).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLR8ARIsr_qBu60_6V72A37vnDr5rRbYfRnpaKTFJXBLKvy1yHjSewjNdGBEmcqZ3eJoI6nqQGqyEtTIogd5Is_kvSRMj9oBMXiEackLb3NqZON2LZG36dreOchc80Q87PLoIu3lQ7Mf9QjrfnJN6NMgpZDyVFMW3F5lJnmrz30a8cG9bezDM0HIMEWJ4w/s320/images%20(13).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbOo5jofekpzVOt7letzrOEiIKeTcZa2GE3Xl6FQzlXB_5pkQdBpHkbMuLjZ-Bv9pxRf8BQvSrR0YAiS3oXDcJg0mdfOWepuwq2CVi0XryrLoAwyz0b8hyGAPlf5XS5pvUAXmowP-nSG8fnSdZAIPBSvjW4UL6nxSPXSxSaPFSimZSbdkRvCh7Ym4bpYqE/s554/images%20(14).jpeg"
        ];


        const postContainer = document.getElementById("post-container");
        const searchInput = document.getElementById("search-input");
        const loginIcon = document.getElementById("login-icon");
        const loginModal = document.getElementById("login-modal");
        const signupModal = document.getElementById("signup-modal");
        const loginForm = document.getElementById("login-form");
        const signupForm = document.getElementById("signup-form");
        const switchToSignupBtn = document.getElementById("switch-to-signup");
        const switchToLoginBtn = document.getElementById("switch-to-login");
        const userProfileDiv = document.getElementById("user-profile");
        const avatarImg = document.getElementById("avatar-img");
        const usernameSpan = document.getElementById("username");
        const logoutBtn = document.getElementById("logout-btn");
        const postDetailsModal = document.getElementById("post-details-modal");
        const postDetailsTitle = document.getElementById("post-details-title");
        const postDetailsContent = document.getElementById("post-details-content");
        const avatarOptionsContainer = document.getElementById("avatar-options-container");
        const signupAvatarInput = document.getElementById("signup-avatar");
        const settingsBtn = document.getElementById("settings-link");
        const settingsModal = document.getElementById("settings-modal");
        const clearHistoryBtn = document.getElementById("clear-history-btn-history-modal"); // Corrected ID
        const settingsAvatarOptionsContainer = document.getElementById("settings-avatar-options-container");
        const settingsAvatarInput = document.getElementById("settings-avatar");
        const profileDropdown = document.getElementById("profile-dropdown");
        const resetPasscodeLink = document.getElementById("reset-passcode-link");
        const resetPasscodeModal = document.getElementById("reset-passcode-modal");
        const resetPasscodeForm = document.getElementById("reset-passcode-form");
        const currentPasscodeInput = document.getElementById("current-passcode");
        const newPasscodeInput = document.getElementById("new-passcode");
        const confirmNewPasscodeInput = document.getElementById("confirm-new-passcode");
        const currentPasscodeError = document.getElementById("current-passcode-error");
        const newPasscodeError = document.getElementById("new-passcode-error");
        const confirmNewPasscodeError = document.getElementById("confirm-new-passcode-error");
        const changeUsernameInput = document.getElementById("change-username");
        const saveUsernameBtn = document.getElementById("save-username-btn");
        const changeUsernameError = document.getElementById("change-username-error");
        const historyLink = document.getElementById("history-link");
        const historyModal = document.getElementById("history-modal");
        const historyList = document.getElementById("history-list");
        const historyMessageDiv = document.getElementById("history-message");
        const notificationButton = document.getElementById("notification-button"); // New notification button
        const notificationModal = document.getElementById("notification-modal"); // New notification modal
        const notificationList = document.getElementById("notification-list"); // New notification list element
        const scrollToTopBtn = document.getElementById("scroll-to-top-btn"); // Get the scroll to top button


        // New Loading Screen Elements
        const loadingOverlay = document.getElementById("loading-overlay");
        const loadingAvatarImg = document.getElementById("loading-avatar-img");
        const loadingUsernameSpan = document.getElementById("loading-username");
        const mainContentDiv = document.getElementById("main-content");

        // New Multi-Account Elements
        const addAccountLink = document.getElementById("add-account-link");
        const switchAccountLink = document.getElementById("switch-account-link");
        const switchAccountModal = document.getElementById("switch-account-modal");
        const accountListDiv = document.getElementById("account-list");


        let users = JSON.parse(localStorage.getItem("users")) || [];
        // More robust check for loggedInUser on initial load
        let loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (loggedInUser && (!loggedInUser.email || !loggedInUser.username || !loggedInUser.password || !loggedInUser.avatar)) {
             // If loggedInUser exists but is missing essential properties, treat as not logged in
             loggedInUser = null;
             localStorage.removeItem("loggedInUser"); // Clear invalid data
        }

        // Initialize viewHistory based on loggedInUser
        let viewHistory = loggedInUser ? (JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || []) : [];


        // Sample notification data (for demo)
        const sampleNotifications = [
            "New episode of 'Awesome Anime' is available!",
            "Your favorite show 'Cool Series' updated.",
            "Welcome to Anitoono!",
            "Check out the new movie releases!",
            "Maintenance scheduled for tomorrow at 2 AM PKT."
        ];

        const ACCOUNT_LIMIT = 2; // Set the account limit here


        // Helper function to open a modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove("hidden");
             // Add 'show' class for bottom sheet animation
            if (modalId === 'switch-account-modal') {
                 setTimeout(() => { // Allow display:flex to apply before adding show
                     modal.classList.add("show");
                 }, 10); // Small delay
            }
            document.body.style.overflow = "hidden"; // Prevent scrolling background
        }

        // Helper function to close a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            // Remove 'show' class for bottom sheet animation
            if (modalId === 'switch-account-modal') {
                 modal.classList.remove("show");
                 setTimeout(() => { // Hide completely after animation
                     modal.classList.add("hidden");
                     document.body.style.overflow = "auto"; // Restore scrolling background
                 }, 300); // Match CSS transition duration
            } else {
                modal.classList.add("hidden");
                document.body.style.overflow = "auto"; // Restore scrolling background
            }

            // Clear form fields and errors when closing modals
            if (modalId === 'login-modal') {
                loginForm.reset();
                document.getElementById("login-email-error").style.display = "none";
                document.getElementById("login-password-error").style.display = "none";
                 // Remove any previous error messages
                 const existingError = loginForm.querySelector('.message-box.error');
                 if (existingError) {
                     existingError.remove();
                 }
            } else if (modalId === 'signup-modal') {
                 signupForm.reset();
                document.getElementById("signup-email-error").style.display = "none";
                document.getElementById("signup-username-error").style.display = "none";
                document.getElementById("signup-password-error").style.display = "none";
                 document.getElementById("signup-avatar-error").style.display = "none";
                  // Remove any previous error messages
                 const existingError = signupForm.querySelector('.message-box.error');
                 if (existingError) {
                     existingError.remove();
                 }
            } else if (modalId === 'reset-passcode-modal') {
                 resetPasscodeForm.reset();
                 currentPasscodeError.style.display = "none";
                 newPasscodeError.style.display = "none";
                 confirmNewPasscodeError.style.display = "none";
                  // Remove any previous messages
                 const existingMessage = resetPasscodeModal.querySelector('.message-box');
                 if (existingMessage) {
                     existingMessage.remove();
                 }
            } else if (modalId === 'settings-modal') {
                 // Clear username input and error on close
                 changeUsernameInput.value = '';
                 changeUsernameError.style.display = 'none';
                 // Remove any previous messages
                 const existingMessage = settingsModal.querySelector('.message-box');
                 if (existingMessage) {
                     existingMessage.remove();
                 }
            } else if (modalId === 'history-modal') {
                 // Clear history message on close
                 historyMessageDiv.style.display = 'none';
                 historyMessageDiv.textContent = '';
            } else if (modalId === 'notification-modal') {
                 // No form fields to clear in the notification modal
            }
        }

         // Helper function to display messages (errors or success)
         function displayMessage(formElement, message, type) {
            // Remove any existing message boxes
            const existingMessage = formElement.querySelector('.message-box');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-box', type);
            messageDiv.textContent = message;

             // Insert message before the submit button or at the end of the form
             const submitButton = formElement.querySelector('button[type="submit"]');
             if (submitButton) {
                 formElement.insertBefore(messageDiv, submitButton);
             } else {
                 formElement.appendChild(messageDiv);
             }
         }


        function validateEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        function displayInitialPosts() {
            postContainer.innerHTML = ""; // Clear previous posts
            initialPosts.forEach((post) => {
                const postElement = createPostElement(post);
                postContainer.appendChild(postElement);
            });
             // Add skeleton effect initially
            addSkeletonEffect();
        }

         // Function to add skeleton effect
        function addSkeletonEffect() {
            const postCards = document.querySelectorAll('.post-card');
            postCards.forEach(card => {
                card.classList.add('skeleton');
            });
        }

        // Function to remove skeleton effect after a delay
        function removeSkeletonEffect(delay = 1500) { // Default delay of 1.5 seconds
            setTimeout(() => {
                const postCards = document.querySelectorAll('.post-card.skeleton');
                postCards.forEach(card => {
                    card.classList.remove('skeleton');
                });
            }, delay);
        }


        function createPostElement(post) {
            const postElement = document.createElement("div");
            postElement.classList.add("post-card"); // Use the new post-card class
            postElement.addEventListener("click", () => {
                // Redirect to the post URL when clicked
                window.location.href = post.url;
                updateViewHistory(post);
            });

            const imageElement = document.createElement("img");
            imageElement.src = post.imageUrl;
            imageElement.alt = post.title;
            // Tailwind classes for image are now in the .post-card img rule

            const contentElement = document.createElement("div");
            contentElement.classList.add("post-card-content"); // Use the new post-card-content class

            const titleElement = document.createElement("h3");
            titleElement.textContent = post.title;
            // Tailwind classes for title are now in the .post-card-content h3 rule

            const descriptionElement = document.createElement("p");
            descriptionElement.textContent = post.content;
             // Tailwind classes for description are now in the .post-card-content p rule

            contentElement.appendChild(titleElement);
            contentElement.appendChild(descriptionElement);
            postElement.appendChild(imageElement);
            postElement.appendChild(contentElement);

            return postElement;
        }

         function updateViewHistory(post) {
            if (loggedInUser) { // Only update history if a user is logged in
                // Check if the post is already in history
                const postInHistory = viewHistory.find(item => item.id === post.id);
                if (!postInHistory) {
                    viewHistory.push(post);
                    // Save history to localStorage using the logged-in user's email as key
                    localStorage.setItem(`history_${loggedInUser.email}`, JSON.stringify(viewHistory));
                }
            }
        }

        function renderHistory() {
            historyList.innerHTML = ""; // Clear previous history items
             // Load history for the currently logged-in user
            viewHistory = loggedInUser ? (JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || []) : [];

            if (viewHistory.length === 0) {
                const listItem = document.createElement("li");
                listItem.textContent = "Your viewing history is empty.";
                historyList.appendChild(listItem);
                 clearHistoryBtn.classList.add('hidden'); // Hide clear button if history is empty
            } else {
                 clearHistoryBtn.classList.remove('hidden'); // Show clear button if history is not empty
                // Display history in reverse order (most recent first)
                for (let i = viewHistory.length - 1; i >= 0; i--) {
                    const post = viewHistory[i];
                    const listItem = document.createElement("li");
                    listItem.textContent = post.title; // Display the post title
                    historyList.appendChild(listItem);
                }
            }
        }


        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredPosts = initialPosts.filter((post) =>
                post.title.toLowerCase().includes(searchTerm)
            );

            postContainer.innerHTML = ""; // Clear previous posts
            filteredPosts.forEach((post) => {
                const postElement = createPostElement(post);
                postContainer.appendChild(postElement);
            });
            // Add skeleton effect to filtered posts and then remove
            addSkeletonEffect();
            removeSkeletonEffect(500); // Shorter delay for search results
        }

        function renderAvatarOptions(container, selectedAvatarInput, currentAvatar = null) {
            container.innerHTML = ""; // Clear previous avatars
            avatarImages.forEach((avatar, index) => {
                const avatarOption = document.createElement("div");
                avatarOption.classList.add("avatar-option", "rounded-full", "cursor-pointer", "transition-all", "duration-200", "border-2", "border-transparent");
                avatarOption.innerHTML = `<img src="${avatar}" alt="Avatar ${index + 1}" class="w-10 h-10 rounded-full object-cover">`; // Added object-cover
                avatarOption.dataset.avatar = avatar;

                // Select the current avatar if provided
                if (currentAvatar && currentAvatar === avatar) {
                    avatarOption.classList.add("selected");
                    selectedAvatarInput.value = avatar; // Ensure the input is set here
                }

                avatarOption.addEventListener("click", () => {
                    // Remove selection from any previously selected avatar
                    const selectedAvatar = container.querySelector(".avatar-option.selected");
                    if (selectedAvatar) {
                        selectedAvatar.classList.remove("selected");
                    }
                    avatarOption.classList.add("selected");
                    selectedAvatarInput.value = avatar; // Update the hidden input field
                });
                container.appendChild(avatarOption);
            });
             // Removed the automatic selection of the first avatar
        }

        function loadUserProfile() {
            console.log("loadUserProfile called. loggedInUser:", loggedInUser); // Debugging line
            // Check if loggedInUser is a valid object with essential properties
            if (loggedInUser && loggedInUser.email && loggedInUser.username && loggedInUser.password && loggedInUser.avatar) {
                console.log("User is logged in. Avatar URL:", loggedInUser.avatar); // Debugging line
                userProfileDiv.classList.remove("hidden"); // Show user profile
                loginIcon.classList.add("hidden"); // Hide login icon
                avatarImg.src = loggedInUser.avatar; // This sets the avatar source
                usernameSpan.textContent = loggedInUser.username;

                 // Load the history for the logged-in user
                viewHistory = JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || [];


                // Show/hide Add Account and Switch Account links based on user count
                if (users.length < ACCOUNT_LIMIT) {
                    addAccountLink.classList.remove('hidden');
                } else {
                    addAccountLink.classList.add('hidden');
                }
                if (users.length > 1) {
                     switchAccountLink.classList.remove('hidden');
                } else {
                     switchAccountLink.classList.add('hidden');
                }


            } else {
                console.log("User is not logged in."); // Debugging line
                // User is not logged in, hide user profile and show login elements
                userProfileDiv.classList.add("hidden"); // Hide user profile
                loginIcon.classList.remove("hidden"); // Show login icon
                 // Explicitly clear avatar and username display
                avatarImg.src = ''; // Clear the avatar image source
                usernameSpan.textContent = ''; // Clear the username text
                 // Ensure the dropdown is hidden when the profile is hidden
                profileDropdown.classList.add('hidden');

                 // Clear the view history as no user is logged in
                viewHistory = [];

                 // Hide multi-account links
                 addAccountLink.classList.add('hidden');
                 switchAccountLink.classList.add('hidden');
            }
        }

        function renderSwitchAccountOptions() {
            accountListDiv.innerHTML = ""; // Clear previous options
            if (users.length === 0) {
                const message = document.createElement('div');
                message.classList.add('text-center', 'text-gray-400');
                message.textContent = "No accounts available.";
                accountListDiv.appendChild(message);
            } else {
                users.forEach(user => { // Iterate through ALL users now
                    const accountOption = document.createElement('div');
                    accountOption.classList.add('account-option');
                    accountOption.dataset.email = user.email; // Store email for switching

                    // Add selected class if this is the logged-in user
                    if (loggedInUser && user.email === loggedInUser.email) {
                        accountOption.classList.add('selected-account');
                    }

                    const avatar = document.createElement('img');
                    avatar.src = user.avatar; // Use the avatar from the user object
                    avatar.alt = user.username;

                    const username = document.createElement('span');
                    username.textContent = user.username;

                    accountOption.appendChild(avatar);
                    accountOption.appendChild(username);

                    // Only add click listener if it's not the currently logged-in user
                    if (!loggedInUser || user.email !== loggedInUser.email) {
                        accountOption.addEventListener('click', () => {
                            // Add loading indicator
                            accountOption.classList.add('switching');
                             const loadingText = document.createElement('span');
                             loadingText.classList.add('loading-text');
                             loadingText.textContent = 'Switching...';
                             accountOption.appendChild(loadingText);


                            // Simulate loading delay
                            setTimeout(() => {
                                // Switch to this account
                                loggedInUser = user;
                                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                                closeModal('switch-account-modal');
                                // Reload profile and posts for the new user
                                loadUserProfile(); // Update header and links (this will also load the correct history)
                                displayInitialPosts(); // Display posts for the new user and add skeleton effect
                                removeSkeletonEffect(); // Remove skeleton effect after a delay

                                 // Remove loading indicator (optional, as modal closes)
                                 accountOption.classList.remove('switching');
                                 loadingText.remove();

                            }, 500); // 500ms delay
                        });
                    }


                    accountListDiv.appendChild(accountOption);
                });
            }
        }


        // Function to render sample notifications
        function renderNotifications(notifications) {
            notificationList.innerHTML = ""; // Clear previous notifications
            if (notifications.length === 0) {
                const listItem = document.createElement("li");
                listItem.classList.add("bg-gray-700", "p-3", "rounded-md", "text-gray-300");
                listItem.textContent = "No new notifications.";
                notificationList.appendChild(listItem);
            } else {
                notifications.forEach(notificationText => {
                    const listItem = document.createElement("li");
                    listItem.classList.add("bg-gray-700", "p-3", "rounded-md", "text-gray-300");
                    listItem.textContent = notificationText;
                    notificationList.appendChild(listItem);
                });
            }
        }


        // Event Listeners
        searchInput.addEventListener("input", handleSearch);
        // Attach event listeners to the icons
        loginIcon.addEventListener("click", () => {
            openModal('login-modal');
        });

        switchToSignupBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            closeModal('login-modal');
            signupAvatarInput.value = ''; // Clear previous avatar selection
            openModal('signup-modal');
            renderAvatarOptions(avatarOptionsContainer, signupAvatarInput);
        });
        switchToLoginBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            closeModal('signup-modal');
            openModal('login-modal');
        });

        loginForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value.trim();
            let hasErrors = false;

            // Clear previous error messages
             const existingError = loginForm.querySelector('.message-box.error');
             if (existingError) {
                 existingError.remove();
             }

            if (!validateEmail(email)) {
                document.getElementById("login-email-error").textContent = "Invalid email format";
                document.getElementById("login-email-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("login-email-error").style.display = "none";
            }

            if (!validatePassword(password)) {
                document.getElementById("login-password-error").textContent = "Password must be at least 6 characters";
                document.getElementById("login-password-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("login-password-error").style.display = "none";
            }

            if (hasErrors) {
                return;
            }

            const user = users.find((u) => u.email === email && u.password === password);
            if (user) {
                loggedInUser = user;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));
                closeModal('login-modal');
                 // Re-run loadUserProfile after successful login to update header and account links (this will also load the correct history)
                loadUserProfile();
                displayInitialPosts(); // Redisplay posts after successful login and add skeleton effect
                removeSkeletonEffect(); // Remove skeleton effect after a delay
            } else {
                displayMessage(loginForm, 'Invalid credentials. Please try again.', 'error');
            }
        });

        signupForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const email = document.getElementById("signup-email").value.trim();
            const username = document.getElementById("signup-username").value.trim();
            const password = document.getElementById("signup-password").value.trim();
            const avatar = signupAvatarInput.value;
            let hasErrors = false;

             // Clear previous error messages
             const existingError = signupForm.querySelector('.message-box.error');
             if (existingError) {
                 existingError.remove();
             }

             // Check account limit BEFORE validation
             if (users.length >= ACCOUNT_LIMIT) {
                 displayMessage(signupForm, `Account limit (${ACCOUNT_LIMIT}) reached. Cannot create more accounts.`, 'error');
                 return; // Stop the signup process
             }


             if (!validateEmail(email)) {
                document.getElementById("signup-email-error").textContent = "Invalid email format";
                document.getElementById("signup-email-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-email-error").style.display = "none";
            }

            if (!username) {
                document.getElementById("signup-username-error").textContent = "Username is required";
                document.getElementById("signup-username-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-username-error").style.display = "none";
            }


            if (!validatePassword(password)) {
                document.getElementById("signup-password-error").textContent = "Password must be at least 6 characters";
                document.getElementById("signup-password-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-password-error").style.display = "none";
            }

            if (!avatar) {
                document.getElementById("signup-avatar-error").textContent = "Please select an avatar";
                document.getElementById("signup-avatar-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-avatar-error").style.display ="none";
            }

            if (hasErrors) {
                return;
            }

            // Check if the email is already taken
            const emailExists = users.some(user => user.email === email);
            if (emailExists) {
                document.getElementById("signup-email-error").textContent = "Email already exists";
                document.getElementById("signup-email-error").style.display = "block";
                return;
            }

             // Check if the username is already taken
            const usernameExists = users.some(user => user.username === username);
            if (usernameExists) {
                document.getElementById("signup-username-error").textContent = "Username already exists";
                document.getElementById("signup-username-error").style.display = "block";
                return;
            }


            const newUser = {
                email,
                username,
                password, // In a real app, hash this password!
                avatar,
            };

            users.push(newUser);
            localStorage.setItem("users", JSON.stringify(users));
            loggedInUser = newUser; // Automatically log in the new user
            localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

             // Initialize history for the new user
            viewHistory = [];
            localStorage.setItem(`history_${loggedInUser.email}`, JSON.stringify(viewHistory));


            closeModal('signup-modal');
            loadUserProfile(); // Call loadUserProfile after successful signup to update header and account links
            displayInitialPosts(); // Redisplay posts after successful signup and add skeleton effect
            removeSkeletonEffect(); // Remove skeleton effect after a delay
        });

        logoutBtn.addEventListener("click", (event) => {
             event.preventDefault(); // Prevent default link behavior

            // Store the email of the user being logged out
            const loggedOutUserEmail = loggedInUser ? loggedInUser.email : null;

            // Filter out the logged-out user from the users array
            users = users.filter(user => user.email !== loggedOutUserEmail);
            localStorage.setItem("users", JSON.stringify(users)); // Update users in local storage

            // Check if there are any remaining accounts
            if (users.length > 0) {
                // Switch to the first available account in the updated users array
                loggedInUser = users[0];
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                 // Simulate a brief loading state
                 loadingOverlay.style.display = 'flex';
                 mainContentDiv.style.display = 'none';
                 loadingAvatarImg.src = loggedInUser.avatar;
                 loadingUsernameSpan.textContent = `Switching to ${loggedInUser.username}...`;

                 setTimeout(() => {
                     loadingOverlay.style.opacity = '0';
                     setTimeout(() => {
                         loadingOverlay.style.display = 'none';
                         loadingOverlay.style.opacity = '1';
                         mainContentDiv.style.display = 'block';
                         loadUserProfile(); // Update header and links based on the new loggedInUser (this will also load the correct history)
                         displayInitialPosts(); // Display posts for the new user and add skeleton effect
                         removeSkeletonEffect(); // Remove skeleton effect after a delay
                     }, 500);
                 }, 1000); // Simulate 1 second switch time


            } else {
                // No other accounts, proceed with regular logout
                loggedInUser = null;
                localStorage.removeItem("loggedInUser");
                viewHistory = []; // Clear history when no user is logged in
                loadUserProfile(); // Call loadUserProfile to update UI (show login icon)
                displayInitialPosts(); // Redisplay posts (might show default content or require login) and add skeleton effect
                removeSkeletonEffect(); // Remove skeleton effect after a delay
            }

             // Hide the dropdown after logging out/switching
            profileDropdown.classList.remove('show'); // Ensure dropdown is hidden
        });

        settingsBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            openModal('settings-modal');
             // Render avatar options for settings, pre-selecting the current avatar
            if(loggedInUser) {
                renderAvatarOptions(settingsAvatarOptionsContainer, settingsAvatarInput, loggedInUser.avatar);
                 // Set the current username in the input field
                changeUsernameInput.value = loggedInUser.username;
            }
        });

        // Event listener for saving username change
        saveUsernameBtn.addEventListener('click', () => {
            const newUsername = changeUsernameInput.value.trim();
             // Clear previous messages and errors
            const settingsModalContent = settingsModal.querySelector('.modal-content');
            const existingMessage = settingsModalContent.querySelector('.message-box');
             if (existingMessage) {
                 existingMessage.remove();
             }
            changeUsernameError.style.display = 'none';


            if (!newUsername) {
                changeUsernameError.textContent = "Username cannot be empty";
                changeUsernameError.style.display = "block";
                return;
            }

            // Check if the new username is already taken by another user
            const usernameExists = users.some(user => user.username === newUsername && user.email !== loggedInUser.email);
            if (usernameExists) {
                 changeUsernameError.textContent = "Username already exists";
                 changeUsernameError.style.display = "block";
                 return;
            }


            if (loggedInUser) {
                loggedInUser.username = newUsername;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                // Update the username in the main users array
                const userIndex = users.findIndex(user => user.email === loggedInUser.email);
                if (userIndex !== -1) {
                    users[userIndex].username = newUsername;
                    localStorage.setItem("users", JSON.stringify(users));
                }

                usernameSpan.textContent = newUsername; // Update header username immediately

                displayMessage(settingsModalContent, 'Username updated successfully!', 'success');

                // Optionally, close the modal after a delay
                setTimeout(() => {
                     closeModal('settings-modal');
                }, 2000); // Close after 2 seconds

            }
        });


        // Event listener for the new History link
        historyLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            renderHistory(); // Render the history list for the current user
            openModal('history-modal'); // Open the history modal
        });

        // Event listener for the Clear History button in the History modal
        clearHistoryBtn.addEventListener("click", () => {
             if (loggedInUser) { // Only clear history if a user is logged in
                viewHistory = [];
                localStorage.removeItem(`history_${loggedInUser.email}`); // Remove history for this specific user
                renderHistory(); // Re-render history to show it's empty

                const historyModalContent = historyModal.querySelector('.modal-content');
                displayMessage(historyModalContent, 'View history cleared!', 'success');

                // Optionally, hide the message after a delay
                setTimeout(() => {
                    const messageBox = historyModalContent.querySelector('.message-box');
                    if (messageBox) messageBox.remove();
                }, 2000); // Hide after 2 seconds
             }
        });


        // Event listener for avatar selection in settings
        settingsAvatarOptionsContainer.addEventListener('click', (event) => {
            const target = event.target.closest('.avatar-option');
            if (target && loggedInUser) {
                const newAvatar = target.dataset.avatar;
                loggedInUser.avatar = newAvatar;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                // Update the avatar in the main users array
                 const userIndex = users.findIndex(user => user.email === loggedInUser.email);
                if (userIndex !== -1) {
                    users[userIndex].avatar = newAvatar;
                    localStorage.setItem("users", JSON.stringify(users));
                }


                avatarImg.src = newAvatar; // Update the avatar in the header immediately

                const settingsModalContent = settingsModal.querySelector('.modal-content');
                displayMessage(settingsModalContent, 'Avatar updated successfully!', 'success');

                // Optionally, close the modal after a delay
                setTimeout(() => {
                     closeModal('settings-modal');
                }, 2000); // Close after 2 seconds
            }
        });


        userProfileDiv.addEventListener('click', () => {
             // Only toggle dropdown visibility if a user is logged in
            if (loggedInUser) {
                 profileDropdown.classList.toggle('show');
            }
        });

        // Modified window click listener to close modals including switch account modal
        window.addEventListener('click', (event) => {
            // Close dropdown if click is outside user profile and dropdown
            if (!userProfileDiv.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('show');
            }

            // Close regular modals if click is outside modal content (but inside modal overlay)
            const modals = document.querySelectorAll('.modal:not(#switch-account-modal)');
            modals.forEach(modal => {
                if (!modal.classList.contains('hidden') && event.target === modal) {
                    closeModal(modal.id);
                }
            });

            // Close switch account modal if click is outside its content (on the overlay)
            const switchModal = document.getElementById('switch-account-modal');
             if (!switchModal.classList.contains('hidden') && switchModal.classList.contains('show') && event.target === switchModal) {
                 closeModal('switch-account-modal');
             }
        });

        resetPasscodeLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent the default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            openModal('reset-passcode-modal'); // Show the reset passcode modal
        });

        resetPasscodeForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const currentPasscode = currentPasscodeInput.value.trim();
            const newPasscode = newPasscodeInput.value.trim();
            const confirmNewPasscode = confirmNewPasscodeInput.value.trim();
            let hasErrors = false;

            // Clear previous errors and messages
            currentPasscodeError.style.display = "none";
            newPasscodeError.style.display = "none";
            confirmNewPasscodeError.style.display = "none";
             const existingMessage = resetPasscodeModal.querySelector('.message-box');
             if (existingMessage) {
                 existingMessage.remove();
             }


            if (!loggedInUser) {
                 // This case should ideally not happen if the link is only shown when logged in
                displayMessage(resetPasscodeForm, 'You must be logged in to reset your passcode.', 'error');
                return;
            }

            // Validate current passcode
            if (currentPasscode !== loggedInUser.password) { // In a real app, compare with hashed password
                currentPasscodeError.textContent = "Incorrect current passcode";
                currentPasscodeError.style.display = "block";
                hasErrors = true;
            }

            // Validate new passcode
            if (!validatePassword(newPasscode)) {
                newPasscodeError.textContent = "New passcode must be at least 6 characters";
                newPasscodeError.style.display = "block";
                hasErrors = true;
            }

            // Validate confirm new passcode
            if (newPasscode !== confirmNewPasscode) {
                confirmNewPasscodeError.textContent = "New passcodes do not match";
                confirmNewPasscodeError.style.display = "block";
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            // Update the password (simulated)
            loggedInUser.password = newPasscode; // In a real app, hash and save the new password
            // Find the user in the users array and update their password
            const userIndex = users.findIndex(user => user.email === loggedInUser.email);
            if (userIndex !== -1) {
                users[userIndex].password = newPasscode;
                localStorage.setItem("users", JSON.stringify(users));
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser)); // Update logged in user in storage
            }

            displayMessage(resetPasscodeForm, 'Passcode reset successfully!', 'success');

            // Optionally, close the modal after a delay
            setTimeout(() => {
                 closeModal('reset-passcode-modal');
            }, 2000); // Close after 2 seconds

             // Clear the form fields
            resetPasscodeForm.reset();
        });

        // Event listener for notification button (Placeholder)
        notificationButton.addEventListener('click', () => {
            renderNotifications(sampleNotifications); // Render sample notifications
            openModal('notification-modal'); // Open the notification modal
        });

        // Event listener for Add Account link
        addAccountLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdown.classList.remove('show'); // Hide dropdown
            // Check account limit before opening signup
            if (users.length < ACCOUNT_LIMIT) {
                 openModal('signup-modal');
                 signupAvatarInput.value = ''; // Clear previous avatar selection
                 renderAvatarOptions(avatarOptionsContainer, signupAvatarInput);
            } else {
                 // Optionally display a message to the user that the limit is reached
                 // This could be a temporary message or a modal
                 alert(`Account limit (${ACCOUNT_LIMIT}) reached. Cannot create more accounts.`);
            }
        });

        // Event listener for Switch Account link
        switchAccountLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdown.classList.remove('show'); // Hide dropdown
            renderSwitchAccountOptions(); // Populate the switch account modal
            openModal('switch-account-modal'); // Open the switch account modal
        });

        // Scroll to top button logic
        window.addEventListener('scroll', () => {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.style.display = 'flex'; // Use flex to maintain centering
            } else {
                scrollToTopBtn.style.display = 'none';
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scrolling
            });
        });


        // Initial setup on page load
        window.onload = function() {
             // Always show loading overlay initially
            loadingOverlay.style.display = 'flex';
            mainContentDiv.style.display = 'none'; // Hide main content

            // Determine loading screen content based on login status
            loadUserProfile(); // This now only sets the loading screen details and header elements' visibility state

             // Set loading screen avatar and username based on loggedInUser or default
            if (loggedInUser) {
                loadingAvatarImg.src = loggedInUser.avatar;
                loadingUsernameSpan.textContent = loggedInUser.username;
            } else {
                 // Use a default avatar and text if not logged in
                 loadingAvatarImg.src = avatarImages[0]; // Or any default image
                 loadingUsernameSpan.textContent = 'Loading...';
            }


            // Hide loading screen and show main content after 3 seconds
            setTimeout(() => {
                loadingOverlay.style.opacity = '0'; // Start fade out
                setTimeout(() => {
                    loadingOverlay.style.display = 'none'; // Hide completely after fade
                    loadingOverlay.style.opacity = '1'; // Reset opacity for next load
                    mainContentDiv.style.display = 'block'; // Show main content

                     // Now that the loading is done and main content is visible,
                     // call loadUserProfile again to ensure correct header state
                     // and display initial posts.
                     loadUserProfile(); // Re-run to set header based on final loggedInUser state (this will also load the correct history)
                     displayInitialPosts(); // Display posts and add skeleton effect
                     removeSkeletonEffect(); // Remove skeleton effect after a delay
                }, 500); // Match CSS transition duration
            }, 3000); // 3 seconds delay for initial loading screen
        };

    </script>
</body>
</html>

