<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anitoono</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Anitoono Theme (Red and Black) */
        body {
            background-color: #0f172a; /* Slightly darker background */
            color: #e2e8f0; /* Lighter text for better contrast */
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            line-height: 1.6;
            /* Ensure overflow is auto by default, handled by JS when modal is open */
            overflow-y: auto;
        }

        body.modal-open {
             overflow: hidden; /* Hide body scroll when a modal is open */
        }


        h1, h2, h3, h4, h5, h6 {
            color: #f87171; /* Lighter red for headings */
        }

        .text-red-500 {
            color: #ef4444; /* Standard Red color from Tailwind */
        }
        .bg-red-500 {
            background-color: #ef4444; /* Standard Red background from Tailwind */
        }
        .hover\:bg-red-600:hover {
            background-color: #dc2626; /* Darker red hover effect */
        }
        .bg-gray-800 {
            background-color: #1e293b; /* Dark gray background */
        }
         .bg-gray-700 {
            background-color: #334155; /* Medium gray background */
        }
        .border-red-500 {
            border-color: #ef4444; /* Red border */
        }
        .focus\:ring-red-500:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5); /* Red focus ring */
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .4; }
        }

        /* Mobile-friendly adjustments */
        .container {
            max-width: 100%; /* Ensure container takes full width on small screens */
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .avatar-option.selected {
            border-color: #ef4444; /* Red border for selected avatar */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.7); /* Enhanced shadow for selection */
        }
         .avatar-option:hover {
            transform: scale(1.1); /* Slightly enlarge on hover */
             transition: transform 0.2s ease-in-out;
        }

        /* Profile Dropdown Styles - NEW DESIGN */
        #user-profile {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem; /* Add padding for larger click area */
            border-radius: 0.375rem; /* Rounded corners */
            transition: background-color 0.2s ease;
        }
         #user-profile:hover {
            background-color: #334155; /* Medium gray background on hover */
        }

        #profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #334155; /* Medium gray background */
            border: none; /* No border */
            border-radius: 0.5rem; /* More rounded corners */
            padding: 0.5rem 0; /* Adjusted padding */
            margin-top: 0.75rem; /* Increased margin */
            min-width: 200px; /* Increased min-width */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5); /* Deeper shadow */
            z-index: 10;
            display: none; /* Initially hidden */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
             overflow: hidden; /* Ensure rounded corners are visible */
        }
        #profile-dropdown.show {
            display: block; /* Show when the show class is added */
            opacity: 1;
            transform: translateY(0);
        }
        #profile-dropdown a {
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center; /* Vertically align items */
            padding: 0.75rem 1.5rem; /* Increased padding */
            color: #cbd5e1; /* Light gray text */
            text-decoration: none;
            transition: color 0.2s ease, background-color 0.2s ease;
            font-size: 1rem; /* Slightly larger font */
             /* No border between items in this design */
        }

        #profile-dropdown a i {
             margin-right: 1rem; /* More space between icon and text */
             width: 1.2rem; /* Fixed width for icons */
             text-align: center; /* Center icon */
             color: #f87171; /* Red color for icons */
        }
        #profile-dropdown a:hover {
            color: #f9fafb; /* White text on hover */
            background-color: #475569; /* Darker gray background on hover */
        }

        /* Modal Styles */
        /* The base modal class is now primarily for the overlay */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.95); /* Darker background with more opacity */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Ensure modals are on top */
            overflow-y: auto; /* Allow scrolling for tall modals */
            padding: 1rem; /* Add padding for mobile */
        }

        .modal-content {
            background-color: #1e293b; /* bg-gray-800 */
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.6); /* Deeper shadow */
            padding: 2.5rem; /* Increased padding */
            width: 100%;
            max-width: 32rem; /* Increased max-width */
            position: relative; /* Needed for close button positioning */
            animation: fadeInScale 0.3s ease-out; /* Add modal entry animation */
        }

         @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .modal-close-button {
            position: absolute;
            top: 1.25rem; /* Adjusted position */
            right: 1.25rem; /* Adjusted position */
            font-size: 1.75rem; /* Larger close icon */
            color: #94a3b8; /* Light gray color */
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #f1f5f9; /* Lighter gray on hover */
        }

        /* Icon Styles */
        .auth-icon {
            width: 28px; /* Adjust size as needed */
            height: 28px; /* Adjust size as needed */
            color: #cbd5e1; /* Light gray color */
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .auth-icon:hover {
            color: #f1f5f9; /* Lighter gray on hover */
        }

         /* History List Styles */
        #history-list {
            list-style: none;
            padding: 0;
        }
        #history-list li {
            background-color: #334155; /* Medium gray */
            padding: 1rem 1.25rem; /* Increased padding */
            margin-bottom: 0.75rem; /* Increased margin */
            border-radius: 0.375rem; /* Rounded corners */
            font-size: 1rem; /* Slightly larger font */
            color: #cbd5e1; /* Light gray text */
            word-break: break-word; /* Prevent long titles from overflowing */
            border-left: 4px solid #ef4444; /* Red accent border */
            transition: background-color 0.2s ease;
        }
         #history-list li:hover {
            background-color: #475569; /* Darker gray on hover */
        }
         #history-list li:last-child {
            margin-bottom: 0;
        }

        /* Notification Button Styling */
        #notification-button {
            background: none;
            border: none;
            color: #cbd5e1; /* Light gray */
            cursor: pointer;
            padding: 0.3rem; /* Reduced padding */
            font-size: 1.3rem; /* Slightly smaller icon */
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* Rounded corners */
             transition: background-color 0.2s ease;
        }

        #notification-button:hover {
            color: #f1f5f9; /* Lighter gray on hover */
             background-color: #334155; /* Medium gray background on hover */
        }

         /* Search Button Styling */
         #search-button {
            background: none;
            border: none;
            color: #cbd5e1; /* Light gray */
            cursor: pointer;
            padding: 0.3rem; /* Reduced padding */
            font-size: 1.3rem; /* Slightly smaller icon */
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* Rounded corners */
             transition: background-color 0.2s ease;
         }

         #search-button:hover {
             color: #f1f5f9; /* Lighter gray on hover */
             background-color: #334155; /* Medium gray background on hover */
         }


        /* Notification List Styling */
        #notification-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem; /* Increased margin */
        }

        #notification-list li {
            background-color: #334155; /* Medium gray */
            padding: 1rem 1.25rem; /* Increased padding */
            margin-bottom: 0.75rem; /* Increased margin */
            border-radius: 0.375rem; /* Rounded corners */
            font-size: 0.95rem; /* Slightly larger font */
            color: #cbd5e1; /* Light gray text */
             border-left: 4px solid #f87171; /* Lighter red accent */
             transition: background-color 0.2s ease;
        }
         #notification-list li:hover {
             background-color: #475569; /* Darker gray on hover */
         }

        #notification-list li:last-child {
            margin-bottom: 0;
        }

        /* Loading Screen Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f172a; /* Same as body background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99; /* High z-index to cover everything */
            transition: opacity 0.5s ease-in-out;
        }

        .loading-avatar-container {
            position: relative;
            width: 100px; /* Larger avatar container */
            height: 100px;
            margin-bottom: 1.5rem; /* Increased margin */
        }

        #loading-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #334155; /* Thicker border around avatar */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); /* Red glow effect */
        }

        .loading-spinner {
            position: absolute;
            top: -15px; /* Position further outside the avatar */
            left: -15px;
            width: 130px; /* Larger spinner */
            height: 130px;
            border: 8px solid rgba(239, 68, 68, 0.2); /* Red with opacity */
            border-top-color: #ef4444; /* Solid red for the spinner part */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-username {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #f1f5f9; /* Lighter white */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); /* Add text shadow */
        }

        /* Hide main content initially */
        #main-content {
            display: none;
        }

        /* Post Card Styling - Modified for Portrait */
        .post-card {
            background-color: #1e293b; /* Dark gray background */
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            overflow: hidden;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer; /* Make the entire card clickable */
            display: flex;
            flex-direction: column; /* Stack image and content */
            width: 100%; /* Ensure it takes full column width */
            position: relative; /* Needed for remove button positioning */
        }

        .post-card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6); /* Stronger shadow on hover */
        }

        .post-card img {
            width: 100%;
            height: 250px; /* Decreased height for smaller portrait */
            object-fit: cover; /* Cover the area without distortion */
            transition: transform 0.3s ease-in-out;
        }

         .post-card:hover img {
            transform: scale(1.05); /* Slightly zoom image on hover */
         }

        .post-card-content {
            padding: 1.25rem; /* Increased padding */
            flex-grow: 1; /* Allow content to take available space */
            display: flex;
            flex-direction: column;
        }

        .post-card-content h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #f87171; /* Lighter red */
            margin-bottom: 0.5rem;
             overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            white-space: nowrap; /* Prevent wrapping */
        }

        .post-card-content p {
            font-size: 0.95rem; /* Slightly larger text */
            color: #cbd5e1; /* Light gray */
            flex-grow: 1; /* Allow description to take space */
             display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Skeleton Screen Styles */
        .post-card.skeleton {
            pointer-events: none; /* Disable clicks during skeleton state */
        }

        .post-card.skeleton img,
        .post-card.skeleton .post-card-content h3,
        .post-card.skeleton .post-card-content p {
            background-color: #334155; /* Medium gray placeholder background */
            color: transparent; /* Hide text */
            border-radius: 4px; /* Rounded corners for placeholders */
            animation: pulse 1.5s infinite ease-in-out; /* Apply pulse animation */
        }

        .post-card.skeleton img {
             /* Maintain image dimensions during skeleton state */
            height: 250px;
            width: 100%;
        }

        .post-card.skeleton .post-card-content h3 {
            height: 1.5rem; /* Placeholder height for title */
            width: 80%; /* Placeholder width for title */
            margin-bottom: 0.5rem;
        }

        .post-card.skeleton .post-card-content p {
            height: 3.5rem; /* Placeholder height for description (approx 3 lines) */
            width: 95%; /* Placeholder width for description */
        }

         /* Remove skeleton styles when not in skeleton state */
         .post-card:not(.skeleton) img {
            background-color: transparent;
            animation: none;
         }
         .post-card:not(.skeleton) .post-card-content h3,
         .post-card:not(.skeleton) .post-card-content p {
            background-color: transparent;
            color: #f87171; /* Restore title color */
            color: #cbd5e1; /* Restore description color */
            animation: none;
         }

        /* Continue Watching Section Styles */
        #continue-watching-section {
            margin-bottom: 2rem; /* Space below the section */
             padding-bottom: 1.5rem; /* Add padding at the bottom */
            border-bottom: 1px solid #334155; /* Subtle separator */
        }

        #continue-watching-section h2 {
            font-size: 1.75rem; /* Larger title */
            font-weight: 700; /* Bold title */
            margin-bottom: 1.5rem; /* Space below the title */
            color: #f87171; /* Match heading color */
        }

        #continue-watching-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Responsive grid */
            gap: 1rem; /* Space between items */
             /* Ensure grid items stretch to fill the row height */
            align-items: stretch;
        }

         /* Main Post Container Styles */
        #post-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Responsive grid */
            gap: 1rem; /* Space between items */
             /* Ensure grid items stretch to fill the row height */
            align-items: stretch;
        }


        /* Form Input Styling */
        .form-input {
             background-color: #334155; /* Medium gray */
            border: 1px solid #475569; /* Darker gray border */
            color: #f1f5f9; /* Lighter text */
            padding: 0.75rem 1rem; /* Increased padding */
            border-radius: 0.375rem; /* Rounded corners */
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #ef4444; /* Red border on focus */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3); /* Red glow on focus */
        }

        /* Button Styling */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem; /* Increased padding */
            font-weight: 600; /* font-semibold */
            text-align: center;
            border-radius: 0.375rem; /* Rounded corners */
            transition: background-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #ef4444; /* Red */
            color: #f9fafb; /* White */
        }

        .btn-primary:hover {
            background-color: #dc2626; /* Darker red on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }

         .btn-secondary {
            background-color: #475569; /* Darker gray */
            color: #cbd5e1; /* Light gray */
         }

         .btn-secondary:hover {
            background-color: #334155; /* Medium gray on hover */
             transform: translateY(-1px); /* Slight lift on hover */
         }

         .btn:active {
            transform: translateY(0); /* Reset lift on click */
         }

        /* Link Styling */
        a {
            color: #f87171; /* Lighter red for links */
            text-decoration: none;
            transition: color 0.2s ease;
        }

        a:hover {
            color: #ef4444; /* Standard red on hover */
            text-decoration: underline;
        }

         /* Message Box Styling (for errors/success) */
         .message-box {
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            text-align: center;
         }

         .message-box.error {
            background-color: #fee2e2; /* Red background */
            color: #b91c1c; /* Dark red text */
            border: 1px solid #ef4444; /* Red border */
         }

         .message-box.success {
            background-color: #d1fae5; /* Green background */
            color: #065f46; /* Dark green text */
            border: 1px solid #10b981; /* Green border */
         }

         /* Bottom Sheet Modal Styles */
        .modal-bottom-sheet {
            position: fixed;
            bottom: 0; /* Start from the bottom */
            left: 0;
            width: 100%;
            height: auto; /* Adjust height based on content */
            max-height: 80%; /* Limit max height */
            background-color: #1e293b; /* Dark gray background */
            border-top-left-radius: 1rem; /* Rounded top corners */
            border-top-right-radius: 1rem;
            box-shadow: 0 -8px 16px rgba(0, 0, 0, 0.5); /* Shadow at the top */
            z-index: 60; /* Higher than other modals */
            display: flex;
            flex-direction: column; /* Arrange children vertically */
            transform: translateY(100%); /* Initially hidden below the screen */
            transition: transform 0.3s ease-out;
            /* Remove overflow-y from the main modal container */
            overflow-y: hidden;
        }

        .modal-bottom-sheet.show {
            transform: translateY(0); /* Slide up into view */
        }

        .modal-bottom-sheet .modal-content {
             /* Override some modal-content styles for the bottom sheet */
            background-color: transparent; /* No background color */
            box-shadow: none; /* No shadow */
            padding: 0 1.5rem 1.5rem 1.5rem; /* Adjusted padding - 0 top, 1.5rem others */
            max-width: none; /* No max width */
            border-radius: 0; /* No border radius */
            animation: none; /* No entry animation */
             /* Ensure content itself can scroll if needed */
            overflow-y: auto;
            flex-grow: 1; /* Allow content to take up remaining space */
        }

        /* Style for the new header handle area */
        .modal-header-handle {
            width: 100%;
            padding: 1.25rem 1.5rem; /* Increased top/bottom padding */
            background-color: #334155; /* Medium gray background */
            border-top-left-radius: 1rem; /* Match modal top border radius */
            border-top-right-radius: 1rem;
            display: flex;
            justify-content: center; /* Center handle indicator */
            align-items: center;
            cursor: grab; /* Indicate it's draggable */
             /* Prevent the handle from scrolling with the content */
            position: sticky;
            top: 0;
            z-index: 1; /* Ensure it's above scrolling content */
             flex-shrink: 0; /* Prevent the handle from shrinking */
             min-height: 40px; /* Ensure a minimum height */
             position: relative; /* Needed for absolute positioning of close button */
        }

        /* Style for the handle indicator */
        .modal-header-handle::before {
            content: '';
            display: block;
            width: 40px; /* Width of the handle indicator */
            height: 5px; /* Height of the handle indicator */
            background-color: #475569; /* Darker gray color for the handle */
            border-radius: 2.5px; /* Rounded corners for the handle */
        }


        /* Style for close button within bottom sheets */
        /* Position it within the handle area */
        .modal-bottom-sheet .modal-close-button {
            position: absolute; /* Position absolutely within the handle */
            top: 50%; /* Center vertically */
            right: 1.5rem; /* Adjusted right position */
            transform: translateY(-50%); /* Adjust for vertical centering */
            font-size: 1.5rem; /* Slightly smaller icon */
            color: #cbd5e1; /* Light gray color */
            cursor: pointer;
            transition: color 0.2s ease;
             z-index: 2; /* Ensure it's above the handle indicator */
        }

        .modal-bottom-sheet .modal-close-button:hover {
            color: #f1f5f9; /* Lighter gray on hover */
        }


        .account-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: #334155; /* Medium gray */
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .account-option:hover {
            background-color: #475569; /* Darker gray on hover */
        }

         .account-option.selected-account {
            border: 2px solid #ef4444; /* Red border for selected account */
            background-color: #1e293b; /* Darker background for selected */
         }

         .account-option.switching {
             opacity: 0.7; /* Dim slightly during switching */
             pointer-events: none; /* Disable clicks during switching */
         }

        .account-option img {
            width: 40px; /* Avatar size */
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
            border: 2px solid #ef4444; /* Red border */
        }

        .account-option span {
            font-size: 1.1rem;
            color: #f1f5f9; /* Lighter text */
            font-weight: 500;
             flex-grow: 1; /* Allow username to take space */
        }

        .account-option .loading-text {
             font-size: 0.9rem;
             color: #f87171; /* Lighter red */
             margin-left: 1rem;
        }

        /* Setting Option Row */
        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0; /* Padding for each setting row */
            border-bottom: 1px solid #334155; /* Separator */
        }

        .setting-option:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .setting-option label {
            font-size: 1rem;
            color: #cbd5e1;
            flex-grow: 1; /* Allow label to take space */
            margin-right: 1rem; /* Space between label and buttons */
        }

         /* Enable/Disable Button Group */
        .enable-disable-group {
            display: flex;
            gap: 0.5rem; /* Space between buttons */
        }

        .enable-disable-group .btn {
            padding: 0.5rem 1rem; /* Smaller padding for these buttons */
            font-size: 0.9rem; /* Smaller font size */
        }

        .enable-disable-group .btn.active {
            background-color: #ef4444; /* Red for active */
            color: #f9fafb; /* White text */
        }

        .enable-disable-group .btn:not(.active) {
             background-color: #475569; /* Darker gray for inactive */
             color: #cbd5e1; /* Light gray text */
        }
         .enable-disable-group .btn:not(.active):hover {
             background-color: #334155; /* Medium gray on hover */
         }

         /* Remove Button on Continue Watching Posts */
        .remove-from-history-btn {
            position: absolute;
            top: 8px; /* Adjust position as needed */
            right: 8px; /* Adjust position as needed */
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black background */
            color: #ef4444; /* Red icon color */
            border: none;
            border-radius: 50%; /* Make it round */
            width: 28px; /* Size of the button */
            height: 28px; /* Size of the button */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1rem; /* Icon size */
            transition: background-color 0.2s ease, color 0.2s ease;
            z-index: 5; /* Ensure it's above the image and content */
            opacity: 0; /* Initially hidden */
            pointer-events: none; /* Disable clicks when hidden */
        }

        .post-card:hover .remove-from-history-btn {
            opacity: 1; /* Show on hover */
            pointer-events: auto; /* Enable clicks on hover */
        }

        .remove-from-history-btn:hover {
            background-color: rgba(0, 0, 0, 0.8); /* Darker background on hover */
            color: #f87171; /* Lighter red on hover */
        }

        /* Profile Details Modal Specific Styles */
        #profile-details-modal .modal-content {
            text-align: center; /* Center content in the profile modal */
        }

        #profile-details-modal .modal-content img {
            width: 80px; /* Larger avatar in modal */
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1.5rem auto; /* Center avatar and add space below */
            border: 4px solid #ef4444; /* Red border */
        }

        #profile-details-modal .modal-content p {
            font-size: 1.1rem;
            color: #cbd5e1;
            margin-bottom: 0.75rem;
        }

        #profile-details-modal .modal-content p strong {
            color: #f87171; /* Lighter red for labels */
            margin-right: 0.5rem;
        }


        /* Scroll to Top Button */
        #scroll-to-top-btn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 20px; /* 20px from the bottom */
            right: 20px; /* 20px from the right */
            z-index: 90; /* High z-index */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: #ef4444; /* Red background */
            color: white; /* White text/icon */
            cursor: pointer; /* Add a mouse pointer on hover */
            width: 50px; /* Set a fixed width */
            height: 50px; /* Set a fixed height */
            border-radius: 50%; /* Make it perfectly round */
            font-size: 18px; /* Increase font size */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Add shadow */
            transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.2s ease; /* Smooth transition */
             opacity: 0.7; /* Slightly transparent when not hovered */
             display: flex; /* Use flexbox to center the icon */
             justify-content: center; /* Center horizontally */
             align-items: center; /* Center vertically */
        }

        #scroll-to-top-btn:hover {
            background-color: #dc2626; /* Darker red on hover */
             opacity: 1; /* Full opacity on hover */
             transform: translateY(-2px); /* Slight lift effect */
        }
         #scroll-to-top-btn:active {
             transform: translateY(0); /* Reset lift on click */
         }

         /* Search Input Container Styling */
         #search-container {
             /* Existing styles */
             transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
             overflow: hidden; /* Hide content when collapsed */
             max-height: 0; /* Initially collapsed */
             opacity: 0; /* Initially hidden */
             position: relative; /* Needed for absolute positioning of clear button/spinner */
             display: flex; /* Use flexbox to align input, clear button, and spinner */
             align-items: center; /* Vertically align items */
         }

         #search-container.show {
             max-height: 100px; /* Sufficient height to show the input */
             opacity: 1; /* Fully visible */
         }

         #search-input {
             flex-grow: 1; /* Allow input to take available space */
             padding-right: 2.5rem; /* Make space for clear button/spinner */
         }

         .search-icon-container {
             position: absolute;
             right: 1rem; /* Position from the right */
             display: flex;
             align-items: center;
             height: 100%; /* Match input height */
             top: 0;
         }

         .clear-search-btn, .search-loading-spinner {
             color: #94a3b8; /* Light gray color */
             cursor: pointer;
             font-size: 1.2rem; /* Icon size */
             transition: color 0.2s ease;
             display: none; /* Initially hidden */
         }

         .clear-search-btn:hover {
             color: #f1f5f9; /* Lighter gray on hover */
         }

         .search-loading-spinner {
             animation: spin 1s linear infinite; /* Apply spin animation */
             margin-left: 0.5rem; /* Space between clear button and spinner */
         }

         /* No Results Message */
         #no-results-message {
             text-align: center;
             color: #cbd5e1;
             font-size: 1.1rem;
             margin-top: 2rem;
             display: none; /* Initially hidden */
         }


    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-overlay">
        <div class="loading-avatar-container">
            <img id="loading-avatar-img" src="" alt="Loading Avatar">
            <div class="loading-spinner"></div>
        </div>
        <span id="loading-username" class="mt-2"></span>
    </div>

    <div id="main-content">
        <header class="bg-gray-800 py-2 flex justify-between items-center shadow-md sticky top-0 z-10 rounded-md">
            <div class="logo text-red-500 text-xl font-semibold ml-4">Anitoono</div> <div class="mr-4 flex items-center space-x-3"> <button id="search-button"> <i class="fas fa-search"></i>
                 </button>
                 <button id="notification-button">
                     <i class="fas fa-bell"></i> </button>
                <div id="login-icon" class="auth-icon hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                </div>
                <div id="user-profile" class="hidden">
                    <img id="avatar-img" src="" alt="Avatar" class="w-8 h-8 rounded-full mr-1 border-2 border-red-500"> <span id="username" class="text-gray-300 font-semibold text-sm"></span> <div id="profile-dropdown" class="hidden">
                        <a href="#" id="view-profile-link">
                             <i class="fas fa-user-circle"></i> Profile
                        </a>
                         <a href="#" id="settings-link">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                         <a href="#" id="history-link">
                            <i class="fas fa-history"></i> History
                        </a>
                         <a href="#" id="reset-passcode-link">
                            <i class="fas fa-key"></i> Reset Passcode
                        </a>
                        <a href="#" id="add-account-link" class="hidden">
                            <i class="fas fa-user-plus"></i> Add Account
                        </a>
                        <a href="#" id="switch-account-link" class="hidden">
                             <i class="fas fa-users"></i> Switch Account
                        </a>
                        <a href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto mt-8 p-4">
             <div id="search-container" class="mb-8 flex justify-center">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search for anime..."
                    class="form-input w-full md:w-2/3 lg:w-1/2"
                    aria-label="Search for anime"
                />
                 <div class="search-icon-container">
                     <button id="clear-search-btn" class="clear-search-btn" aria-label="Clear search input">
                         <i class="fas fa-times-circle"></i>
                     </button>
                     <i id="search-loading-spinner" class="fas fa-spinner fa-spin search-loading-spinner"></i>
                 </div>
            </div>

            <div id="no-results-message" role="alert">
                No results found for your search.
            </div>

            <div id="continue-watching-section" class="hidden">
                <h2>Continue Watching</h2>
                <div id="continue-watching-container">
                    </div>
            </div>

            <div id="post-container">
                </div>
        </main>
    </div>

    <div id="login-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('login-modal')">&times;</span>
        </div>
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Login to Anitoono</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="login-email" class="form-input" required>
                    <div id="login-email-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="login-password" class="form-input" required>
                    <div id="login-password-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Login</button>
            </form>
            <div class="mt-6 text-center text-gray-400">
                <p>Don't have an account? <a href="#" id="switch-to-signup" class="text-red-500 hover:underline">Sign Up</a></p>
            </div>
        </div>
    </div>

    <div id="signup-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('signup-modal')">&times;</span>
         </div>
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Sign Up for Anitoono</h2>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="signup-email" class="form-input" required>
                    <div id="signup-email-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-username" class="block text-gray-300 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="signup-username" class="form-input" required>
                     <div id="signup-username-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="signup-password" class="form-input" required>
                    <div id="signup-password-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="signup-avatar" class="block text-gray-300 text-sm font-bold mb-2">Choose Avatar:</label>
                    <div class="flex flex-wrap gap-3" id="avatar-options-container">
                        </div>
                    <input type="hidden" id="signup-avatar" name="signup-avatar" value="">
                    <div id="signup-avatar-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Sign Up</button>
            </form>
            <div class="mt-6 text-center text-gray-400">
                <p>Already have an account? <a href="#" id="switch-to-login" class="text-red-500 hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <div id="post-details-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('post-details-modal')">&times;</span>
         </div>
        <div class="modal-content max-w-2xl">
            <h2 id="post-details-title" class="text-2xl font-semibold mb-4 text-red-500"></h2>
            <div id="post-details-content" class="text-gray-300 mb-6"></div>
            <button onclick="closeModal('post-details-modal')" class="btn btn-secondary w-full">Close</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
            <span class="modal-close-button" onclick="closeModal('settings-modal')">&times;</span>
        </div>
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Settings</h2>
            <div class="space-y-4">
                 <div class="setting-option">
                    <label for="change-username">Change Username:</label>
                    <input type="text" id="change-username" class="form-input flex-grow ml-4">
                    </div>
                 <div id="change-username-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                 <button id="save-username-btn" class="btn btn-primary w-full mt-4">Save Username</button>


                <div class="setting-option flex-col items-start">
                    <label for="change-avatar" class="mb-2">Change Avatar:</label>
                     <div class="flex flex-wrap gap-3" id="settings-avatar-options-container">
                        </div>
                    <input type="hidden" id="settings-avatar" name="settings-avatar" value="">
                    <div id="settings-avatar-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>

                <div class="setting-option">
                    <label>Enable Continue Watching:</label>
                    <div class="enable-disable-group">
                        <button class="btn btn-secondary" id="enable-continue-watching-btn">Enable</button>
                        <button class="btn btn-secondary" id="disable-continue-watching-btn">Disable</button>
                    </div>
                </div>

                 <div class="setting-option">
                    <label>Save Viewing History:</label>
                    <div class="enable-disable-group">
                        <button class="btn btn-secondary" id="enable-save-history-btn">Enable</button>
                        <button class="btn btn-secondary" id="disable-save-history-btn">Disable</button>
                    </div>
                </div>


                <button onclick="closeModal('settings-modal')" class="btn btn-secondary w-full mt-6">Close</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('history-modal')">&times;</span>
         </div>
        <div class="modal-content max-lg">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Viewing History</h2>
            <ul id="history-list" class="mb-6">
                </ul>
             <button id="clear-history-btn-history-modal" class="btn btn-primary w-full mb-4">Clear History</button>
            <button onclick="closeModal('history-modal')" class="btn btn-secondary w-full">Close</button>
             <div id="history-message" class="text-center mt-4 text-green-500" style="display: none;"></div> </div>
    </div>

    <div id="notification-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('notification-modal')">&times;</span>
        </div>
        <div class="modal-content max-sm">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Notifications</h2>
            <ul id="notification-list" class="space-y-4">
                 <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    New episode of "Awesome Anime" is available!
                </li>
                <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    Your favorite show "Cool Series" updated.
                </li>
                <li class="bg-gray-700 p-3 rounded-md text-gray-300">
                    Welcome to Anitoono!
                </li>
            </ul>
            <button onclick="closeModal('notification-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        </div>
    </div>

    <div id="profile-details-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
             <span class="modal-close-button" onclick="closeModal('profile-details-modal')">&times;</span>
         </div>
        <div class="modal-content max-sm">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">My Profile</h2>
             <img id="profile-modal-avatar" src="" alt="User Avatar">
             <p><strong>Username:</strong> <span id="profile-modal-username"></span></p>
             <p><strong>Email:</strong> <span id="profile-modal-email"></span></p>
            <button onclick="closeModal('profile-details-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        </div>
    </div>

    <div id="reset-passcode-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
            <span class="modal-close-button" onclick="closeModal('reset-passcode-modal')">&times;</span>
        </div>
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Reset Passcode</h2>
            <form id="reset-passcode-form" class="space-y-6">
                 <div>
                    <label for="current-passcode" class="block text-gray-300 text-sm font-bold mb-2">Current Passcode:</label>
                    <input type="password" id="current-passcode" class="form-input" required>
                    <div id="current-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <div>
                    <label for="new-passcode" class="block text-gray-300 text-sm font-bold mb-2">New Passcode:</label>
                    <input type="password" id="new-passcode" class="form-input" required>
                    <div id="new-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                 <div>
                    <label for="confirm-new-passcode" class="block text-gray-300 text-sm font-bold mb-2">Confirm New Passcode:</label>
                    <input type="password" id="confirm-new-passcode" class="form-input" required>
                    <div id="confirm-new-passcode-error" class="text-red-500 text-xs italic mt-1" style="display: none;"></div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Reset Passcode</button>
            </form>
        </div>
    </div>

     <div id="switch-account-modal" class="modal-bottom-sheet hidden">
        <div class="modal-header-handle">
            <span class="modal-close-button" onclick="closeModal('switch-account-modal')">&times;</span>
        </div>
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-6 text-red-500 text-center">Switch Account</h2>
            <div id="account-list" class="space-y-4">
                </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">
        <i class="fas fa-arrow-up"></i>
    </button>


    <script>
        // Data for initial posts (before search)
        let initialPosts = [ // Changed to 'let' so it can be shuffled
                                                { id: 1, title: "Super Mario Bros Movie", content: "click to watch", imageUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0ZJ6mD8c41yfKCkzMB31PjOc4lQAHsjBtPblEk8rgFZEKA55VOrvPLaB7Xu7n9NQmvq9H4AMSCMTSE4w6K0DYegjEluUG8aXeNgf3DQEtGga8kbesrTn58botILFHXORCDCEIN7Ar8Q1jn0FDNrOw_orbasxl6jyZE1l9BvDJQO9Mnb3Ae0aut25qCAji/s320/images%20(16).jpeg", url: "https://anitoono45.github.io/super-mario-bros/" },
            { id: 2, title: "The glassworker", content: "click to watch.", imageUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjIUXm_1t8BPBw1giZXIo-ng9wBEWN1sqEUmWBJAb6pgNaR3foGxYsMwOEhV5bfZ01wlB6nRPqOl6A06lmy1VE3BaGVM8QTUotS2fc3ol_dI8XYfCu9BRxYCcDFf0_a-5IujAMnzmvayUeuCNwRVcg6Fx3XwgbTJo5CXiXp2B9yBmZip2vymSkQjIGdeizN/s320/images%20(17).jpeg", url: "https://anitoono45.github.io/The-glassworker/" },
             { id: 4, title: "The luck Movie", content: "click to watch",imageUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhryblKlxmlDovuvylSoutki5vxx7v4iz6MxWj7Wz46Ba0sveY27m_D29YQ7HohFTKNJloAZ_ridH8WwS1RVgxjgngCsWsgr2fKOy4s4MF_kaoYeME1BvtQ-032EEZmPRAj0juQNKO1wEnWmpat39zB62uiFbTdQxcLPx0jLtxWzLW0lE0F1kkzP1m1sEAX/s371/Luck_(2022)_poster.png", url: "https://anitoono45.github.io/The-Luck-Movie/" },
            { id: 4, title: "Anime Title r", content: "Anime description 4.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+4", url: "watch.html?id=4" },
            { id: 5, title: "Anime Title 5", content: "Anime description 5.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+5", url: "watch.html?id=5" },
            { id: 6, title: "Anime Title 6", content: "Anime description 6.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+6", url: "watch.html?id=6" },
            { id: 7, title: "Anime Title 7", content: "Anime description 7.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+7", url: "watch.html?id=7" },
            { id: 8, title: "Anime Title 8", content: "Anime description 8.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+8", url: "watch.html?id=8" },
            { id: 9, title: "Anime Title 9", content: "Anime description 9.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+9", url: "watch.html?id=9" },
            { id: 10, title: "Anime Title 10", content: "Anime description 10.", imageUrl: "https://placehold.co/400x550/EEE/31343C?text=Poster+10", url: "watch.html?id=10" },
            // Add your new posts here, like this:
            // { id: 11, title: "New Anime Title 1", content: "Description for new anime.", imageUrl: "URL_OF_YOUR_IMAGE", url: "watch.html?id=11" },
            // { id: 12, title: "New Anime Title 2", content: "Another great show.", imageUrl: "URL_OF_ANOTHER_IMAGE", url: "watch.html?id=12" },
        ];

        const avatarImages = [
                                              "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_ca_A9wrVuMNYNAdMBEAmVr38Yjmag2WlX0UUf5N_WxpNAGw4qb9dNUfCxLwM1rBM0l1QOxUmETHQAdqiOHFfUEQMg9aXBIthMj7K1AA8s4Tz9iW6n4jTLJ9rA_BgmJjWLljrdzH5QBlrhILastYFv-xqUGaX2Qb3tGZlSUDu9KIkqoTukabVotXeerZB/s320/images%20(12).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjXN0Bpdhj1_h9DlhuWzNEe3YTNtlszbxSmVPJW_r6qgd7gayt8DFCct7Sx8DgwAbcWv1jJc2LpB1HbcpnUrjAUHbqYZQwVlBiyACPWRqmmiej278Qi30ohOejsqUmntWcanAy26k6McmKMRrqIjpq3KpakAJsaY3Jh29zMnoqzgEf0sBk8NuvdDzWdGT_/s320/images%20(11).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLywX0IbfA4QLd_SuOlEfXVoS0b-cCfC7GlTRmVdPFAEzAiqa3tA56ncL-oO_9D1RyY-E7LBNetKRv7QyFXrOUOPnAnONhjzUlfxeSmWyXIyKvu91MrgCeUjn-wW6UuoA6QNU05HHmzGp9lnHFhBYmFR4UOASEcdqiyQs3_5dHLbR9I5wfRGGB9VZoEvxw/s320/images%20(2).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2jwXiTITDNaryWwfg6M9dsQgVubEmdnB7YMCINoo3x461EsIsld575Gd58fcKCqvc-cSefLtfv3nicIEoUFKRshcAjB07SuKx6POHk5aXkjcqZ2YzQDAmB_NXoBDEJQbHcmJOS6gBPc2oNGq9DRegcXKyX1hTs7PlN___6djPc90CADsXu4CoWjmDjnDX/s320/images%20(4).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaHQZq0-mmCLhwBksZgdP2f4kvb9dhAZQnj18Ybp44gSyuFvBh_s5CqOjknay3J6zqA8mSbPEPHFhF3BXG_nJRC5Rm2lGbhnDlhU2yZ8Zpm7VJa7msj02OxO5nViuX4yryhwklae-z1kB-w77uFzqXYIDtRx-QYNxeFFJbb6C9PErjTsLW0_OXCyTJV6Vp/s320/images%20(5).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLTZ4ZG3T2qklL16G4WRTFB3BFGN-B5dJViu3UhurzaVqdGueXdeHRevqy6jN5iKDZsxnGpWyjIiRvCbEaX9z3NXbWgxPlOAwl0i7_ZPeQ4GE5iuJBT8yhXjbOmRUnFJ-KXBk2kjRgNBXZDZct9lJUrVdunTW661fbWaEAm4AINsda_jaVgKyEFxYdLlyD/s320/images%20(6).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgj8BQrcI51_OMaNoAGctizntzxqFOnQ5rMrc7nnGcjPvYQFvvCAUK6Kj2UgPwT-JoraIiLylOV6YUhwY_ntMiUw9DbcWDNni5SQrdY5SdhjneuGISPF65zZrePrqQ2YKF5LpFkWjrnnK1sjmo31Y-Y0zzJt7vds5wW7bdNtSoeqfFFqOVTwx8A-Zz-tuaW/s320/images%20(7).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhMgph7LCDPbAosa6RR0YKqE59bdCCX94_wjHCNwPAPENrKLcEgJQRUyUoj9baUZVNPzhtW8MF4E61MyhU9Q0Bx-9UI57iLYCnfgxVIcM7tKCRmkYlaOKgMVs8J4Sc2IMx9XGyhjv6pietuw8rAnr1y6SjQ9xjwnhc_XSOyDY_dct1NgvZFCRkF2q0F_RQ_/s320/images%20(8).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2Vo2WUIjen2aktqxxIhzeFpgII5MEKvZPuzDJBxMeyHrwQzAS615EV-MdV7dcmhyphenhyphenT_9n7hVS6xPTf2PjrPWbySLt7EhDAvcXOVn8WCWU9FZ6vo-hpYzTzIR5LZVGKPmnLmuSJsDZIM9aKkkTmno0B9h-_n8smRp_Wj-DA1dWW3YFNbN7omXDHEJqW97DC/s320/images%20(9).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEDKdFKhlfGAInoUdFLTdpRZ5OGxi27Vnb_Na4cSB7E86N_AuMOnQbXNel0V4WR7gNauEmzISn6fsn8iLumyv1IHOB3Mnz7UAckriREfy5tmEaFQkLQr62muQHf-hOpj-LtjLbpP1Z9O6vbOZM09xT6Yry0KtojLHcOVIU_KzGhxUm4zbiyf65rB0Ecoav/s320/images%20(10).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLR8ARIsr_qBu60_6V72A37vnDr5rRbYfRnpaKTFJXBLKvy1yHjSewjNdGBEmcqZ3eJoI6nqQGqyEtTIogd5Is_kvSRMj9oBMXiEackLb3NqZON2LZG36dreOchc80Q87PLoIu3lQ7Mf9QjrfnJN6NMgpZDyVFMW3F5lJnmrz30a8cG9bezDM0HIMEWJ4w/s320/images%20(13).jpeg",
                       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbOo5jofekpzVOt7letzrOEiIKeTcZa2GE3Xl6FQzlXB_5pkQdBpHkbMuLjZ-Bv9pxRf8BQvSrR0YAiS3oXDcJg0mdfOWepuwq2CVi0XryrLoAwyz0b8hyGAPlf5XS5pvUAXmowP-nSG8fnSdZAIPBSvjW4UL6nxSPXSxSaPFSimZSbdkRvCh7Ym4bpYqE/s554/images%20(14).jpeg",
                                              "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjfgnNxaphMQu4635iXGAoBsWv3RVIDt7WYzL7qrHS0YwSy-7PcQprLWzuQIikqkBoVTLpOi-y2Mo4Ke81599Yf0dt41ZQpIOPeQlpl1pH7ALHp16vWJ-_YPY5ZLV3XiuklfK5jXWCnYjN2EEX6mhIavbW_IWvKzlND9FtySuTg8WK9zncqWy9rjvSEaQmJ/s320/91c7465bad4f872e805f6a32ff946461.jpg",
            "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFo74xshPdL1B1MvVmvpdyenYwgJXQ-J1O35J_lY0Jc7usutM_0CjcnRBjElRZUCFfcEakTJooZ4jgc4Ue7uF8PBqoj5Bj_DsBJmVtJIdOXpcPyYAZUGm5AqDM0jDTlotmImDyg1AD6t9Ua265D0TAwVPaoMyU5Hu3ycy0x0p78OXGhyphenhyphenvyCrJxmbIlENPQ/s320/b7889fadbcb5ba406e459ceaafe63ec7.jpg",
            "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjwIJ9ntvynjV7W8iCtPYT6wEft5HVfKXpaKTvjnTLlpj012mOXAkB6c1kd8w823fZv93mLzPZJ5zN0O8UDHd6woKMyEygwU6WqXS6Q9di9CrUATTQ7kqlacvlYKkjbPeBJVxG6EOUWwvMt15wT3WzmQi4rhQo-7UK0O7fhimF5WpgzMxfZK3RKlqcshjGH/s736/674a3c41f18db2e52b81632d54efca75.jpg",
            "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhz8YpI3dFaT6hsN3uDhat7OrCLhY7SZk9mwb8sTz1rGcYx8pDNDyUjpO_PfMQPXnheGfyMyrRa1f3ZP7N1UTPvVLMhuqVNQTzcly9xMH_8lii3VozgUNgwhFwdxeyXXgmyzNTGeDP-0zHLPKx6wqWB-h4_1g7_KBrIz_9daUj0J4MUCg54930HQ21PUX59/s320/10ed0c3d6a489f246dddf84788115520.jpg",
        ];


        const postContainer = document.getElementById("post-container");
        const searchInput = document.getElementById("search-input");
        const loginIcon = document.getElementById("login-icon");
        const loginModal = document.getElementById("login-modal");
        const signupModal = document.getElementById("signup-modal");
        const loginForm = document.getElementById("login-form");
        const signupForm = document.getElementById("signup-form");
        const switchToSignupBtn = document.getElementById("switch-to-signup");
        const switchToLoginBtn = document.getElementById("switch-to-login");
        const userProfileDiv = document.getElementById("user-profile");
        const avatarImg = document.getElementById("avatar-img");
        const usernameSpan = document.getElementById("username");
        const logoutBtn = document.getElementById("logout-btn");
        const postDetailsModal = document.getElementById("post-details-modal");
        const postDetailsTitle = document.getElementById("post-details-title");
        const postDetailsContent = document.getElementById("post-details-content");
        const avatarOptionsContainer = document.getElementById("avatar-options-container");
        const signupAvatarInput = document.getElementById("signup-avatar");
        const settingsBtn = document.getElementById("settings-link");
        const settingsModal = document.getElementById("settings-modal");
        const clearHistoryBtn = document.getElementById("clear-history-btn-history-modal"); // Corrected ID
        const settingsAvatarOptionsContainer = document.getElementById("settings-avatar-options-container");
        const settingsAvatarInput = document.getElementById("settings-avatar");
        const profileDropdown = document.getElementById("profile-dropdown");
        const resetPasscodeLink = document.getElementById("reset-passcode-link");
        const resetPasscodeModal = document.getElementById("reset-passcode-modal");
        const resetPasscodeForm = document.getElementById("reset-passcode-form");
        const currentPasscodeInput = document.getElementById("current-passcode");
        const newPasscodeInput = document.getElementById("new-passcode");
        const confirmNewPasscodeInput = document.getElementById("confirm-new-passcode");
        const currentPasscodeError = document.getElementById("current-passcode-error");
        const newPasscodeError = document.getElementById("new-passcode-error");
        const confirmNewPasscodeError = document.getElementById("confirm-new-passcode-error");
        const changeUsernameInput = document.getElementById("change-username");
        const saveUsernameBtn = document.getElementById("save-username-btn");
        const changeUsernameError = document.getElementById("change-username-error");
        const historyLink = document.getElementById("history-link");
        const historyModal = document.getElementById("history-modal");
        const historyList = document.getElementById("history-list");
        const historyMessageDiv = document.getElementById("history-message");
        const notificationButton = document.getElementById("notification-button"); // New notification button
        const notificationModal = document.getElementById("notification-modal"); // New notification modal
        const notificationList = document.getElementById("notification-list"); // New notification list element
        const scrollToTopBtn = document.getElementById("scroll-to-top-btn"); // Get the scroll to top button

        // New Continue Watching Elements
        const continueWatchingSection = document.getElementById('continue-watching-section');
        const continueWatchingContainer = document.getElementById('continue-watching-container');

        // New Settings Buttons (replacing toggles)
        const enableContinueWatchingBtn = document.getElementById('enable-continue-watching-btn');
        const disableContinueWatchingBtn = document.getElementById('disable-continue-watching-btn');
        const enableSaveHistoryBtn = document.getElementById('enable-save-history-btn');
        const disableSaveHistoryBtn = document.getElementById('disable-save-history-btn');

        // New Profile Details Modal Elements
        const viewProfileLink = document.getElementById('view-profile-link');
        const profileDetailsModal = document.getElementById('profile-details-modal');
        const profileModalAvatar = document.getElementById('profile-modal-avatar');
        const profileModalUsername = document.getElementById('profile-modal-username');
        const profileModalEmail = document.getElementById('profile-modal-email');


        // New Loading Screen Elements
        const loadingOverlay = document.getElementById("loading-overlay");
        const loadingAvatarImg = document.getElementById("loading-avatar-img");
        const loadingUsernameSpan = document.getElementById("loading-username");
        const mainContentDiv = document.getElementById("main-content");

        // New Multi-Account Elements
        const addAccountLink = document.getElementById("add-account-link");
        const switchAccountLink = document.getElementById("switch-account-link");
        const switchAccountModal = document.getElementById("switch-account-modal");
        const accountListDiv = document.getElementById("account-list");

        // New Search Elements
        const searchButton = document.getElementById('search-button'); // Get the new search button
        const searchContainer = document.getElementById('search-container'); // Get the search input container
        const clearSearchBtn = document.getElementById('clear-search-btn'); // Get the clear search button
        const searchLoadingSpinner = document.getElementById('search-loading-spinner'); // Get the search loading spinner
        const noResultsMessage = document.getElementById('no-results-message'); // Get the no results message element

        // Get all modal header handle elements for swipe gestures
        const modalHeaderHandles = document.querySelectorAll('.modal-bottom-sheet .modal-header-handle');


        let users = JSON.parse(localStorage.getItem("users")) || [];
        // More robust check for loggedInUser on initial load
        let loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (loggedInUser && (!loggedInUser.email || !loggedInUser.username || !loggedInUser.password || !loggedInUser.avatar)) {
             // If loggedInUser exists but is missing essential properties, treat as not logged in
             loggedInUser = null;
             localStorage.removeItem("loggedInUser"); // Clear invalid data
        }

        // Initialize viewHistory based on loggedInUser
        let viewHistory = loggedInUser ? (JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || []) : [];

        // Initialize settings based on loggedInUser or defaults
        let userSettings = loggedInUser ? (JSON.parse(localStorage.getItem(`settings_${loggedInUser.email}`)) || { enableContinueWatching: true, saveHistory: true }) : { enableContinueWatching: true, saveHistory: true };


        // Sample notification data (for demo)
        const sampleNotifications = [
            "New episode of 'Awesome Anime' is available!",
            "Your favorite show 'Cool Series' updated.",
            "Welcome to Anitoono!",
            "Check out the new movie releases!",
            "Maintenance scheduled for tomorrow at 2 AM PKT."
        ];

        const ACCOUNT_LIMIT = 2; // Set the account limit here

        let searchTimeout; // Variable to hold the debounce timeout

        let touchstartY = 0; // To track the start of a touch for swipe


        // Helper function to open a modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove("hidden");
             // Add 'show' class for bottom sheet animation
            if (modal.classList.contains('modal-bottom-sheet')) {
                 setTimeout(() => { // Allow display:flex to apply before adding show
                     modal.classList.add("show");
                 }, 10); // Small delay
            }
            // Add class to body to disable scrolling
            document.body.classList.add('modal-open');
        }

        // Helper function to close a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            // Remove 'show' class for bottom sheet animation
            if (modal.classList.contains('modal-bottom-sheet')) {
                 modal.classList.remove("show");
                 setTimeout(() => { // Hide completely after animation
                     modal.classList.add("hidden");
                     // Remove class from body to re-enable scrolling
                     document.body.classList.remove('modal-open');
                 }, 300); // Match CSS transition duration
            } else {
                modal.classList.add("hidden");
                // Remove class from body to re-enable scrolling
                document.body.classList.remove('modal-open');
            }

            // Clear form fields and errors when closing modals
            if (modalId === 'login-modal') {
                loginForm.reset();
                document.getElementById("login-email-error").style.display = "none";
                document.getElementById("login-password-error").style.display = "none";
                 // Remove any previous error messages
                 const existingMessage = loginForm.querySelector('.message-box.error');
                 if (existingMessage) {
                     existingMessage.remove();
                 }
            } else if (modalId === 'signup-modal') {
                 signupForm.reset();
                document.getElementById("signup-email-error").style.display = "none";
                document.getElementById("signup-username-error").style.display = "none";
                document.getElementById("signup-password-error").style.display = "none";
                 document.getElementById("signup-avatar-error").style.display = "none";
                  // Remove any previous error messages
                 const existingError = signupForm.querySelector('.message-box.error');
                 if (existingError) {
                     existingError.remove();
                 }
            } else if (modalId === 'reset-passcode-modal') {
                 resetPasscodeForm.reset();
                 currentPasscodeError.style.display = "none";
                 newPasscodeError.style.display = "none";
                 confirmNewPasscodeError.style.display = "none";
                  // Remove any previous messages
                 const existingMessage = resetPasscodeModal.querySelector('.modal-content').querySelector('.message-box');
                 if (existingMessage) {
                     existingMessage.remove();
                 }
            } else if (modalId === 'settings-modal') {
                 // Clear username input and error on close
                 changeUsernameInput.value = '';
                 changeUsernameError.style.display = 'none';
                 // Remove any previous messages
                 const existingMessage = settingsModal.querySelector('.modal-content').querySelector('.message-box');
                 if (existingMessage) {
                     existingMessage.remove();
                 }
            } else if (modalId === 'history-modal') {
                 // Clear history message on close
                 historyMessageDiv.style.display = 'none';
                 historyMessageDiv.textContent = '';
            } else if (modalId === 'notification-modal') {
                 // No form fields to clear in the notification modal
            } else if (modalId === 'profile-details-modal') {
                 // No form fields to clear in the profile details modal
            }
        }

         // Helper function to display messages (errors or success)
         function displayMessage(containerElement, message, type) {
            // Remove any existing message boxes within the specific container
            const existingMessage = containerElement.querySelector('.message-box');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-box', type);
            messageDiv.textContent = message;

             // Insert message at the beginning of the container
             containerElement.insertBefore(messageDiv, containerElement.firstChild);
         }


        function validateEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        // Function to shuffle an array (Fisher-Yates (aka Knuth) Shuffle)
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;

            // While there remain elements to shuffle.
            while (currentIndex !== 0) {

                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }

            return array;
        }

        // Function to get the list of posts to display in the main section
        function getPostsForDisplay() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let postsToDisplay = initialPosts;

            // 1. Filter by search term if present
            if (searchTerm !== "") {
                postsToDisplay = initialPosts.filter((post) =>
                    post.title.toLowerCase().includes(searchTerm)
                );
            } else {
                // 2. If no search term, filter out posts in "Continue Watching" if enabled and logged in
                if (loggedInUser && userSettings.enableContinueWatching && userSettings.saveHistory) {
                    // Load the latest history for the current user
                    viewHistory = JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || [];
                    postsToDisplay = initialPosts.filter(post =>
                        !viewHistory.some(historyItem => historyItem.id === post.id)
                    );
                } else {
                     // If not logged in, continue watching disabled, or history saving disabled, show all initial posts
                     postsToDisplay = initialPosts;
                }
            }

             // 3. Shuffle the resulting list (only if no search term, or if you want search results shuffled too)
             // For now, let's only shuffle when there's no search term
             if (searchTerm === "") {
                 postsToDisplay = shuffleArray(postsToDisplay);
             }


            return postsToDisplay;
        }


        function displayPosts(postsToDisplay) {
            postContainer.innerHTML = ""; // Clear previous posts

            // Show/hide no results message based on the result of getPostsForDisplay and search term
            if (postsToDisplay.length === 0 && searchInput.value.trim() !== "") {
                 noResultsMessage.style.display = 'block';
            } else {
                 noResultsMessage.style.display = 'none';
                 postsToDisplay.forEach((post) => {
                    const postElement = createPostElement(post, false); // Pass false for isContinueWatching
                    postContainer.appendChild(postElement);
                });
                 // Add skeleton effect initially
                addSkeletonEffect();
                 // Remove skeleton effect after a delay
                removeSkeletonEffect();
            }
        }

         // Function to add skeleton effect
        function addSkeletonEffect() {
            const postCards = document.querySelectorAll('#post-container .post-card'); // Only target main posts
            postCards.forEach(card => {
                card.classList.add('skeleton');
            });
        }

        // Function to remove skeleton effect after a delay
        function removeSkeletonEffect(delay = 1500) { // Default delay of 1.5 seconds
            setTimeout(() => {
                const postCards = document.querySelectorAll('#post-container .post-card.skeleton'); // Only target main posts
                postCards.forEach(card => {
                    card.classList.remove('skeleton');
                });
            }, delay);
        }


        function createPostElement(post, isContinueWatching = false) {
            const postElement = document.createElement("div");
            postElement.classList.add("post-card"); // Use the new post-card class
            postElement.dataset.postId = post.id; // Add data attribute for post ID

            // Add click listener to the post card
            postElement.addEventListener("click", () => {
                // Redirect to the post URL when clicked
                window.location.href = post.url;
                updateViewHistory(post); // Update history when a post is clicked
            });


            const imageElement = document.createElement("img");
            imageElement.src = post.imageUrl;
            imageElement.alt = post.title;
            // Tailwind classes for image are now in the .post-card img rule

            const contentElement = document.createElement("div");
            contentElement.classList.add("post-card-content"); // Use the new post-card-content class

            const titleElement = document.createElement("h3");
            titleElement.textContent = post.title;
            // Tailwind classes for title are now in the .post-card-content h3 rule

            const descriptionElement = document.createElement("p");
            descriptionElement.textContent = post.content;
             // Tailwind classes for description are now in the .post-card-content p rule

            contentElement.appendChild(titleElement);
            contentElement.appendChild(descriptionElement);
            postElement.appendChild(imageElement);
            postElement.appendChild(contentElement);

            // Add remove button if it's for the Continue Watching section
            if (isContinueWatching) {
                const removeButton = document.createElement('button');
                removeButton.classList.add('remove-from-history-btn');
                removeButton.innerHTML = '<i class="fas fa-times"></i>'; // Font Awesome times icon
                removeButton.dataset.postId = post.id; // Store post ID on the button

                removeButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent click from triggering the post click
                    const postIdToRemove = parseInt(event.currentTarget.dataset.postId);
                    removePostFromHistory(postIdToRemove);
                });

                postElement.appendChild(removeButton);
            }


            return postElement;
        }

         function updateViewHistory(post) {
            if (loggedInUser && userSettings.saveHistory) { // Only update history if a user is logged in AND history saving is enabled
                // Check if the post is already in history
                const postInHistoryIndex = viewHistory.findIndex(item => item.id === post.id);

                if (postInHistoryIndex !== -1) {
                    // If already in history, remove the old entry
                    viewHistory.splice(postInHistoryIndex, 1);
                }

                // Add the post to the end (most recent)
                viewHistory.push(post);

                // Optional: Limit history size (e.g., to 20 items)
                const historyLimit = 20;
                if (viewHistory.length > historyLimit) {
                    viewHistory = viewHistory.slice(viewHistory.length - historyLimit);
                }


                // Save history to localStorage using the logged-in user's email as key
                localStorage.setItem(`history_${loggedInUser.email}`, JSON.stringify(viewHistory));
                 // Update continue watching section immediately after adding to history
                renderContinueWatching();
                 // Update main posts display to remove the watched item
                displayPosts(getPostsForDisplay());
            }
        }

        function removePostFromHistory(postId) {
             if (loggedInUser) {
                 // Filter out the post with the matching ID
                 viewHistory = viewHistory.filter(post => post.id !== postId);
                 // Save the updated history back to localStorage
                 localStorage.setItem(`history_${loggedInUser.email}`, JSON.stringify(viewHistory));
                 // Re-render the continue watching section
                 renderContinueWatching();
                 // Re-render the history modal if it's open
                 if (!historyModal.classList.contains('hidden')) {
                     renderHistory();
                 }
                 // Re-render the main posts display to potentially add the removed item back
                 displayPosts(getPostsForDisplay());
             }
        }


        function renderHistory() {
            historyList.innerHTML = ""; // Clear previous history items
             // Load history for the currently logged-in user
            viewHistory = loggedInUser ? (JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || []) : [];

            if (viewHistory.length === 0) {
                const listItem = document.createElement("li");
                listItem.textContent = "Your viewing history is empty.";
                historyList.appendChild(listItem);
                 clearHistoryBtn.classList.add('hidden'); // Hide clear button if history is empty
            } else {
                 clearHistoryBtn.classList.remove('hidden'); // Show clear button if history is not empty
                // Display history in reverse order (most recent first)
                for (let i = viewHistory.length - 1; i >= 0; i--) {
                    const post = viewHistory[i];
                    const listItem = document.createElement("li");
                    listItem.textContent = post.title; // Display the post title
                    historyList.appendChild(listItem);
                }
            }
        }

        function renderContinueWatching() {
             continueWatchingContainer.innerHTML = ""; // Clear previous continue watching posts

            if (loggedInUser && userSettings.enableContinueWatching && viewHistory.length > 0) { // Check if continue watching is enabled and history is not empty
                 continueWatchingSection.classList.remove('hidden'); // Show the section

                 // Filter initialPosts to find the ones in the current user's history
                 // Display in reverse order (most recent first)
                 const continueWatchingPosts = initialPosts.filter(post =>
                     viewHistory.some(historyItem => historyItem.id === post.id)
                 ).reverse(); // Reverse to show most recent first

                 // Display the continue watching posts
                 continueWatchingPosts.forEach(post => {
                     const postElement = createPostElement(post, true); // Pass true for isContinueWatching
                     continueWatchingContainer.appendChild(postElement);
                 });

            } else {
                 continueWatchingSection.classList.add('hidden'); // Hide the section if no user, continue watching disabled, or empty history
                 continueWatchingContainer.innerHTML = ""; // Ensure container is empty
            }
        }

        function saveUserSettings() {
             if (loggedInUser) {
                localStorage.setItem(`settings_${loggedInUser.email}`, JSON.stringify(userSettings));
             }
        }

        function loadUserSettings() {
             if (loggedInUser) {
                userSettings = JSON.parse(localStorage.getItem(`settings_${loggedInUser.email}`)) || { enableContinueWatching: true, saveHistory: true };
             } else {
                 // Default settings if not logged in
                 userSettings = { enableContinueWatching: true, saveHistory: true };
             }
             // Update the button states in the settings modal when loaded
             updateSettingsButtonStates();
        }

         function updateSettingsButtonStates() {
             if (enableContinueWatchingBtn && disableContinueWatchingBtn) {
                 if (userSettings.enableContinueWatching) {
                     enableContinueWatchingBtn.classList.add('active');
                     disableContinueWatchingBtn.classList.remove('active');
                 } else {
                     enableContinueWatchingBtn.classList.remove('active');
                     disableContinueWatchingBtn.classList.add('active');
                 }
             }
             if (enableSaveHistoryBtn && disableSaveHistoryBtn) {
                 if (userSettings.saveHistory) {
                     enableSaveHistoryBtn.classList.add('active');
                     disableSaveHistoryBtn.classList.remove('active');
                 } else {
                     enableSaveHistoryBtn.classList.remove('active');
                     disableSaveHistoryBtn.classList.add('active');
                 }
             }
         }


        // Debounced search function
        function debounce(func, delay) {
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    func.apply(context, args);
                }, delay);
            };
        }

        // Actual search logic
        function performSearch() {
            // performSearch now just triggers a re-render of the main posts based on the current search input
            displayPosts(getPostsForDisplay());

            // Hide spinner (assuming search is fast or handled elsewhere)
            searchLoadingSpinner.style.display = 'none';

            // Show clear button if input is not empty
            if (searchInput.value.trim() !== "") {
                clearSearchBtn.style.display = 'inline-block';
            } else {
                 clearSearchBtn.style.display = 'none';
            }
        }

        // Debounced version of performSearch
        const debouncedSearch = debounce(performSearch, 300); // 300ms debounce delay


        function renderAvatarOptions(container, selectedAvatarInput, currentAvatar = null) {
            container.innerHTML = ""; // Clear previous avatars
            avatarImages.forEach((avatar, index) => {
                const avatarOption = document.createElement("div");
                avatarOption.classList.add("avatar-option", "rounded-full", "cursor-pointer", "transition-all", "duration-200", "border-2", "border-transparent");
                avatarOption.innerHTML = `<img src="${avatar}" alt="Avatar ${index + 1}" class="w-10 h-10 rounded-full object-cover">`; // Added object-cover
                avatarOption.dataset.avatar = avatar;

                // Select the current avatar if provided
                if (currentAvatar && currentAvatar === avatar) {
                    avatarOption.classList.add("selected");
                    selectedAvatarInput.value = avatar; // Ensure the input is set here
                }

                avatarOption.addEventListener("click", () => {
                    // Remove selection from any previously selected avatar
                    const selectedAvatar = container.querySelector(".avatar-option.selected");
                    if (selectedAvatar) {
                        selectedAvatar.classList.remove("selected");
                    }
                    avatarOption.classList.add("selected");
                    selectedAvatarInput.value = avatar; // Update the hidden input field
                });
                container.appendChild(avatarOption);
            });
             // Removed the automatic selection of the first avatar
        }

        function loadUserProfile() {
            console.log("loadUserProfile called. loggedInUser:", loggedInUser); // Debugging line
            // Check if loggedInUser is a valid object with essential properties
            if (loggedInUser && loggedInUser.email && loggedInUser.username && loggedInUser.password && loggedInUser.avatar) {
                console.log("User is logged in. Avatar URL:", loggedInUser.avatar); // Debugging line
                userProfileDiv.classList.remove("hidden"); // Show user profile
                loginIcon.classList.add("hidden"); // Hide login icon
                avatarImg.src = loggedInUser.avatar; // This sets the avatar source
                usernameSpan.textContent = loggedInUser.username;

                 // Load the history for the logged-in user
                viewHistory = JSON.parse(localStorage.getItem(`history_${loggedInUser.email}`)) || [];

                 // Load settings for the logged-in user
                loadUserSettings();

                // Show/hide Add Account and Switch Account links based on user count
                if (users.length < ACCOUNT_LIMIT) {
                    addAccountLink.classList.remove('hidden');
                } else {
                    addAccountLink.classList.add('hidden');
                }
                if (users.length > 1) {
                     switchAccountLink.classList.remove('hidden');
                } else {
                     switchAccountLink.classList.add('hidden');
                }

                // Render continue watching section for the logged-in user (respects settings)
                renderContinueWatching();

                // Populate profile details modal if it's open (shouldn't be initially, but good practice)
                 if (!profileDetailsModal.classList.contains('hidden')) {
                    populateProfileDetailsModal();
                 }


            } else {
                console.log("User is not logged in."); // Debugging line
                // User is not logged in, hide user profile and show login elements
                userProfileDiv.classList.add("hidden"); // Hide user profile
                loginIcon.classList.remove("hidden"); // Show login icon
                 // Explicitly clear avatar and username display
                avatarImg.src = ''; // Clear the avatar image source
                usernameSpan.textContent = ''; // Clear the username text
                 // Ensure the dropdown is hidden when the profile is hidden
                profileDropdown.classList.add('hidden');

                 // Clear the view history as no user is logged in
                viewHistory = [];
                 userSettings = { enableContinueWatching: true, saveHistory: true }; // Reset settings to default


                 // Hide multi-account links
                 addAccountLink.classList.add('hidden');
                 switchAccountLink.classList.add('hidden');

                 // Hide continue watching section when not logged in
                 continueWatchingSection.classList.add('hidden');
                 continueWatchingContainer.innerHTML = ""; // Clear continue watching posts
            }
        }

        function renderSwitchAccountOptions() {
            accountListDiv.innerHTML = ""; // Clear previous options
            if (users.length === 0) {
                const message = document.createElement('div');
                message.classList.add('text-center', 'text-gray-400');
                message.textContent = "No accounts available.";
                accountListDiv.appendChild(message);
            } else {
                users.forEach(user => { // Iterate through ALL users now
                    const accountOption = document.createElement('div');
                    accountOption.classList.add('account-option');
                    accountOption.dataset.email = user.email; // Store email for switching

                    // Add selected class if this is the logged-in user
                    if (loggedInUser && user.email === loggedInUser.email) {
                        accountOption.classList.add('selected-account');
                    }

                    const avatar = document.createElement('img');
                    avatar.src = user.avatar; // Use the avatar from the user object
                    avatar.alt = user.username;

                    const username = document.createElement('span');
                    username.textContent = user.username;

                    accountOption.appendChild(avatar);
                    accountOption.appendChild(username);

                    // Only add click listener if it's not the currently logged-in user
                    if (!loggedInUser || user.email !== loggedInUser.email) {
                        accountOption.addEventListener('click', () => {
                            // Add loading indicator
                            accountOption.classList.add('switching');
                             const loadingText = document.createElement('span');
                             loadingText.classList.add('loading-text');
                             loadingText.textContent = 'Switching...';
                             accountOption.appendChild(loadingText);


                            // Simulate loading delay
                            setTimeout(() => {
                                // Switch to this account
                                loggedInUser = user;
                                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));
                                closeModal('switch-account-modal');
                                // Reload profile and posts for the new user
                                loadUserProfile(); // Update header and links (this will also load the correct history and render continue watching)
                                // Re-render main posts for the new user (respects new history)
                                displayPosts(getPostsForDisplay());


                                 // Remove loading indicator (optional, as modal closes)
                                 accountOption.classList.remove('switching');
                                 loadingText.remove();

                            }, 500); // 500ms delay
                        });
                    }


                    accountListDiv.appendChild(accountOption);
                });
            }
        }

        // Function to populate the profile details modal
        function populateProfileDetailsModal() {
            if (loggedInUser) {
                profileModalAvatar.src = loggedInUser.avatar;
                profileModalUsername.textContent = loggedInUser.username;
                profileModalEmail.textContent = loggedInUser.email;
            } else {
                 // Clear details if somehow the modal is opened without a logged-in user
                 profileModalAvatar.src = '';
                 profileModalUsername.textContent = 'N/A';
                 profileModalEmail.textContent = 'N/A';
            }
        }


        // Function to render sample notifications
        function renderNotifications(notifications) {
            notificationList.innerHTML = ""; // Clear previous notifications
            if (notifications.length === 0) {
                const listItem = document.createElement("li");
                listItem.classList.add("bg-gray-700", "p-3", "rounded-md", "text-gray-300");
                listItem.textContent = "No new notifications.";
                notificationList.appendChild(listItem);
            } else {
                notifications.forEach(notificationText => {
                    const listItem = document.createElement("li");
                    listItem.classList.add("bg-gray-700", "p-3", "rounded-md", "text-gray-300");
                    listItem.textContent = notificationText;
                    notificationList.appendChild(listItem);
                });
            }
        }


        // Function to shuffle and display posts
        function shuffleAndDisplayPosts() {
             // Only shuffle and display if the search input is empty
            if (searchInput.value.trim() === "") {
                // Get posts for display (which includes filtering out history and shuffling)
                const postsToDisplay = getPostsForDisplay();
                displayPosts(postsToDisplay); // Display the shuffled and filtered posts
            } else {
                 // If there's a search term, just re-display the current filtered posts
                 performSearch(); // Use performSearch directly without debounce for immediate display after other actions
            }
        }


        // Event Listeners
        // Use the debounced search function for input events
        searchInput.addEventListener("input", () => {
             // Show clear button and potentially hide spinner immediately on input
            if (searchInput.value.trim() !== "") {
                 clearSearchBtn.style.display = 'inline-block';
            } else {
                 clearSearchBtn.style.display = 'none';
                 // If input is cleared, immediately perform search to show all posts
                 performSearch();
                 return; // Stop the debounce timer if input is empty
            }
            searchLoadingSpinner.style.display = 'inline-block'; // Show spinner on typing
            debouncedSearch(); // Call the debounced search
        });

         // Event listener for the clear search button
         clearSearchBtn.addEventListener('click', () => {
             searchInput.value = ''; // Clear the input field
             clearSearchBtn.style.display = 'none'; // Hide the clear button
             performSearch(); // Perform search with empty term to show all posts
             searchInput.focus(); // Put focus back on the search input
         });


        // Attach event listeners to the icons
        loginIcon.addEventListener("click", () => {
            openModal('login-modal');
        });

        switchToSignupBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            closeModal('login-modal');
            signupAvatarInput.value = ''; // Clear previous avatar selection
            openModal('signup-modal');
            renderAvatarOptions(avatarOptionsContainer, signupAvatarInput);
        });
        switchToLoginBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            closeModal('signup-modal');
            openModal('login-modal');
        });

        loginForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value.trim();
            let hasErrors = false;

            // Clear previous error messages
             const existingMessage = loginForm.querySelector('.message-box.error');
             if (existingMessage) {
                 existingMessage.remove();
             }

            if (!validateEmail(email)) {
                document.getElementById("login-email-error").textContent = "Invalid email format";
                document.getElementById("login-email-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("login-email-error").style.display = "none";
            }

            if (!validatePassword(password)) {
                document.getElementById("login-password-error").textContent = "Password must be at least 6 characters";
                document.getElementById("login-password-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("login-password-error").style.display = "none";
            }

            if (hasErrors) {
                return;
            }

            const user = users.find((u) => u.email === email && u.password === password);
            if (user) {
                loggedInUser = user;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));
                closeModal('login-modal');
                 // Re-run loadUserProfile after successful login to update header and account links (this will also load the correct history and render continue watching)
                loadUserProfile();
                displayPosts(getPostsForDisplay()); // Display main posts after successful login (respects new history)

            } else {
                displayMessage(loginForm, 'Invalid credentials. Please try again.', 'error');
            }
        });

        signupForm.addEventListener("submit", (event) => {
            event.preventDefault();

            const email = document.getElementById("signup-email").value.trim();
            const username = document.getElementById("signup-username").value.trim();
            const password = document.getElementById("signup-password").value.trim();
            const avatar = signupAvatarInput.value;
            let hasErrors = false;

             // Clear previous error messages
             const existingMessage = signupForm.querySelector('.message-box.error');
             if (existingMessage) {
                 existingMessage.remove();
             }

             // Check account limit BEFORE validation
             if (users.length >= ACCOUNT_LIMIT) {
                 displayMessage(signupForm, `Account limit (${ACCOUNT_LIMIT}) reached. Cannot create more accounts.`, 'error');
                 return; // Stop the signup process
             }


             if (!validateEmail(email)) {
                document.getElementById("signup-email-error").textContent = "Invalid email format";
                document.getElementById("signup-email-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-email-error").style.display = "none";
            }

            if (!username) {
                document.getElementById("signup-username-error").textContent = "Username is required";
                document.getElementById("signup-username-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-username-error").style.display = "none";
            }


            if (!validatePassword(password)) {
                document.getElementById("signup-password-error").textContent = "Password must be at least 6 characters";
                document.getElementById("signup-password-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-password-error").style.display = "none";
            }

            if (!avatar) {
                document.getElementById("signup-avatar-error").textContent = "Please select an avatar";
                document.getElementById("signup-avatar-error").style.display = "block";
                hasErrors = true;
            } else {
                document.getElementById("signup-avatar-error").style.display ="none";
            }

            if (hasErrors) {
                return;
            }

            // Check if the email is already taken
            const emailExists = users.some(user => user.email === email);
            if (emailExists) {
                document.getElementById("signup-email-error").textContent = "Email already exists";
                document.getElementById("signup-email-error").style.display = "block";
                return;
            }

             // Check if the username is already taken
            const usernameExists = users.some(user => user.username === username);
            if (usernameExists) {
                document.getElementById("signup-username-error").textContent = "Username already exists";
                document.getElementById("signup-username-error").style.display = "block";
                return;
            }


            const newUser = {
                email,
                username,
                password, // In a real app, hash this password!
                avatar,
            };

            users.push(newUser);
            localStorage.setItem("users", JSON.stringify(users));
            loggedInUser = newUser; // Automatically log in the new user
            localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

             // Initialize history for the new user
            viewHistory = [];
            localStorage.setItem(`history_${loggedInUser.email}`, JSON.stringify(viewHistory));

             // Initialize default settings for the new user
             userSettings = { enableContinueWatching: true, saveHistory: true };
             saveUserSettings();


            closeModal('signup-modal');
            loadUserProfile(); // Call loadUserProfile after successful signup to update header and account links and render continue watching
            displayPosts(getPostsForDisplay()); // Display main posts after successful signup (respects new history)
        });

        logoutBtn.addEventListener("click", (event) => {
             event.preventDefault(); // Prevent default link behavior

            // Store the email of the user being logged out
            const loggedOutUserEmail = loggedInUser ? loggedInUser.email : null;

            // Filter out the logged-out user from the users array
            users = users.filter(user => user.email !== loggedOutUserEmail);
            localStorage.setItem("users", JSON.stringify(users)); // Update users in local storage

            // Check if there are any remaining accounts
            if (users.length > 0) {
                // Switch to the first available account in the updated users array
                loggedInUser = users[0];
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                 // Simulate a brief loading state
                 loadingOverlay.style.display = 'flex';
                 mainContentDiv.style.display = 'none';
                 loadingAvatarImg.src = loggedInUser.avatar;
                 loadingUsernameSpan.textContent = `Switching to ${loggedInUser.username}...`;

                 setTimeout(() => {
                     loadingOverlay.style.opacity = '0';
                     setTimeout(() => {
                         loadingOverlay.style.display = 'none';
                         loadingOverlay.style.opacity = '1';
                         mainContentDiv.style.display = 'block';
                         loadUserProfile(); // Update header and links based on the new loggedInUser (this will also load the correct history and render continue watching)
                         displayPosts(getPostsForDisplay()); // Display main posts for the new user (respects new history)
                     }, 500);
                 }, 1000); // Simulate 1 second switch time


            } else {
                // No other accounts, proceed with regular logout
                loggedInUser = null;
                localStorage.removeItem("loggedInUser");
                viewHistory = []; // Clear history when no user is logged in
                 userSettings = { enableContinueWatching: true, saveHistory: true }; // Reset settings to default
                loadUserProfile(); // Call loadUserProfile to update UI (show login icon) and hide continue watching
                displayPosts(getPostsForDisplay()); // Display main posts (will show all initial posts as no user is logged in)
            }

             // Hide the dropdown after logging out/switching
            profileDropdown.classList.remove('show'); // Ensure dropdown is hidden
        });

        settingsBtn.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
             // Load current settings before opening the modal
            loadUserSettings();
            openModal('settings-modal');
             // Render avatar options for settings, pre-selecting the current avatar
            if(loggedInUser) {
                renderAvatarOptions(settingsAvatarOptionsContainer, settingsAvatarInput, loggedInUser.avatar);
                 // Set the current username in the input field
                changeUsernameInput.value = loggedInUser.username;
            }
        });

        // Event listener for saving username change
        saveUsernameBtn.addEventListener('click', () => {
            const newUsername = changeUsernameInput.value.trim();
             // Clear previous messages and errors within the settings modal content
            const settingsModalContent = settingsModal.querySelector('.modal-content');
            const existingMessage = settingsModalContent.querySelector('.message-box');
             if (existingMessage) {
                 existingMessage.remove();
             }
            changeUsernameError.style.display = 'none';


            if (!newUsername) {
                changeUsernameError.textContent = "Username cannot be empty";
                changeUsernameError.style.display = "block";
                return;
            }

            // Check if the new username is already taken by another user
            const usernameExists = users.some(user => loggedInUser && user.email !== loggedInUser.email && user.username === newUsername);
            if (usernameExists) {
                 changeUsernameError.textContent = "Username already exists";
                 changeUsernameError.style.display = "block";
                 return;
            }


            if (loggedInUser) {
                loggedInUser.username = newUsername;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                // Update the username in the main users array
                const userIndex = users.findIndex(user => loggedInUser && user.email === loggedInUser.email);
                if (userIndex !== -1) {
                    users[userIndex].username = newUsername;
                    localStorage.setItem("users", JSON.stringify(users));
                }

                usernameSpan.textContent = newUsername; // Update header username immediately

                displayMessage(settingsModalContent, 'Username updated successfully!', 'success');

                // Optionally, close the modal after a delay
                setTimeout(() => {
                     closeModal('settings-modal');
                }, 2000); // Close after 2 seconds
            }
        });


        // Event listener for the new History link
        historyLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            renderHistory(); // Render the history list for the current user
            openModal('history-modal'); // Open the history modal
        });

        // Event listener for the Clear History button in the History modal
        clearHistoryBtn.addEventListener("click", () => {
             if (loggedInUser) { // Only clear history if a user is logged in
                viewHistory = [];
                localStorage.removeItem(`history_${loggedInUser.email}`); // Remove history for this specific user
                renderHistory(); // Re-render history to show it's empty
                 renderContinueWatching(); // Update continue watching section
                displayPosts(getPostsForDisplay()); // Update main posts display


                const historyModalContent = historyModal.querySelector('.modal-content');
                displayMessage(historyModalContent, 'View history cleared!', 'success');

                // Optionally, hide the message after a delay
                setTimeout(() => {
                    const messageBox = historyModalContent.querySelector('.message-box');
                    if (messageBox) messageBox.remove();
                }, 2000); // Hide after 2 seconds
             }
        });


        // Event listener for avatar selection in settings
        settingsAvatarOptionsContainer.addEventListener('click', (event) => {
            const target = event.target.closest('.avatar-option');
            if (target && loggedInUser) {
                const newAvatar = target.dataset.avatar;
                loggedInUser.avatar = newAvatar;
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser));

                // Update the avatar in the main users array
                 const userIndex = users.findIndex(user => loggedInUser && user.email === loggedInUser.email);
                if (userIndex !== -1) {
                    users[userIndex].avatar = newAvatar;
                    localStorage.setItem("users", JSON.stringify(users));
                }


                avatarImg.src = newAvatar; // Update the avatar in the header immediately

                const settingsModalContent = settingsModal.querySelector('.modal-content');
                displayMessage(settingsModalContent, 'Avatar updated successfully!', 'success');

                // Optionally, close the modal after a delay
                setTimeout(() => {
                     closeModal('settings-modal');
                }, 2000); // Close after 2 seconds
            }
        });

        // Event listeners for the new settings buttons
        if (enableContinueWatchingBtn && disableContinueWatchingBtn && enableSaveHistoryBtn && disableSaveHistoryBtn) {
             enableContinueWatchingBtn.addEventListener('click', () => {
                 if (loggedInUser) {
                     userSettings.enableContinueWatching = true;
                     saveUserSettings();
                     renderContinueWatching(); // Update the display based on the new setting
                     displayPosts(getPostsForDisplay()); // Update main posts display
                     updateSettingsButtonStates(); // Update button appearance
                 }
             });

             disableContinueWatchingBtn.addEventListener('click', () => {
                 if (loggedInUser) {
                     userSettings.enableContinueWatching = false;
                     saveUserSettings();
                     renderContinueWatching(); // Update the display based on the new setting
                     displayPosts(getPostsForDisplay()); // Update main posts display
                     updateSettingsButtonStates(); // Update button appearance
                 }
             });

             enableSaveHistoryBtn.addEventListener('click', () => {
                 if (loggedInUser) {
                     userSettings.saveHistory = true;
                     saveUserSettings();
                     updateSettingsButtonStates(); // Update button appearance
                     // Re-render continue watching and main posts based on potentially re-enabled history
                     renderContinueWatching();
                     displayPosts(getPostsForDisplay());
                 }
             });

             disableSaveHistoryBtn.addEventListener('click', () => {
                 if (loggedInUser) {
                     userSettings.saveHistory = false;
                     saveUserSettings();
                     // Note: Disabling save history doesn't clear existing history,
                     // it just stops adding new items. Clearing history is a separate action.
                     updateSettingsButtonStates(); // Update button appearance
                      // Re-render continue watching and main posts based on potentially disabled history
                     renderContinueWatching();
                     displayPosts(getPostsForDisplay());
                 }
             }
             );
        }

        // Event listener for the new View Profile link
        viewProfileLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            populateProfileDetailsModal(); // Populate the modal with current user data
            openModal('profile-details-modal'); // Open the profile details modal
        });


        userProfileDiv.addEventListener('click', () => {
             // Only toggle dropdown visibility if a user is logged in
            if (loggedInUser) {
                 profileDropdown.classList.toggle('show');
            }
        });

        // Modified window click listener to close modals including bottom sheets
        window.addEventListener('click', (event) => {
            // Close dropdown if click is outside user profile and dropdown
            if (!userProfileDiv.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('show');
            }

            // Close regular modals if click is outside modal content (but inside modal overlay)
            const regularModals = document.querySelectorAll('.modal:not(.modal-bottom-sheet)');
            regularModals.forEach(modal => {
                if (!modal.classList.contains('hidden') && event.target === modal) {
                    closeModal(modal.id);
                }
            });

            // Close bottom sheet modals if click is outside its content (on the overlay)
            const bottomSheetModals = document.querySelectorAll('.modal-bottom-sheet');
             bottomSheetModals.forEach(modal => {
                 // Check if the modal is visible and the click is directly on the modal (not its content)
                 if (!modal.classList.contains('hidden') && modal.classList.contains('show') && event.target === modal) {
                     closeModal(modal.id);
                 }
             });
        });

        resetPasscodeLink.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent the default link behavior
            profileDropdown.classList.remove('show'); // Hide the dropdown
            openModal('reset-passcode-modal'); // Show the reset passcode modal
        });

        resetPasscodeForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const currentPasscode = currentPasscodeInput.value.trim();
            const newPasscode = newPasscodeInput.value.trim();
            const confirmNewPasscode = confirmNewPasscodeInput.value.trim();
            let hasErrors = false;

            // Clear previous errors and messages
            currentPasscodeError.style.display = "none";
            newPasscodeError.style.display = "none";
            confirmNewPasscodeError.style.display = "none";
             const existingMessage = resetPasscodeModal.querySelector('.modal-content').querySelector('.message-box');
             if (existingMessage) {
                 existingMessage.remove();
             }


            if (!loggedInUser) {
                 // This case should ideally not happen if the link is only shown when logged in
                displayMessage(resetPasscodeModal.querySelector('.modal-content'), 'You must be logged in to reset your passcode.', 'error');
                return;
            }

            // Validate current passcode
            if (currentPasscode !== loggedInUser.password) { // In a real app, compare with hashed password
                currentPasscodeError.textContent = "Incorrect current passcode";
                currentPasscodeError.style.display = "block";
                hasErrors = true;
            }

            // Validate new passcode
            if (!validatePassword(newPasscode)) {
                newPasscodeError.textContent = "New passcode must be at least 6 characters";
                newPasscodeError.style.display = "block";
                hasErrors = true;
            }

            // Validate confirm new passcode
            if (newPasscode !== confirmNewPasscode) {
                confirmNewPasscodeError.textContent = "New passcodes do not match";
                confirmNewPasscodeError.style.display = "block";
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            // Update the password (simulated)
            loggedInUser.password = newPasscode; // In a real app, hash and save the new password
            // Find the user in the users array and update their password
            const userIndex = users.findIndex(user => loggedInUser && user.email === loggedInUser.email);
            if (userIndex !== -1) {
                users[userIndex].password = newPasscode;
                localStorage.setItem("users", JSON.stringify(users));
                localStorage.setItem("loggedInUser", JSON.stringify(loggedInUser)); // Update logged in user in storage
            }

            displayMessage(resetPasscodeModal.querySelector('.modal-content'), 'Passcode reset successfully!', 'success');

            // Optionally, close the modal after a delay
            setTimeout(() => {
                 closeModal('reset-passcode-modal');
            }, 2000); // Close after 2 seconds

             // Clear the form fields
            resetPasscodeForm.reset();
        });

        // Event listener for notification button (Placeholder)
        notificationButton.addEventListener('click', () => {
            renderNotifications(sampleNotifications); // Render sample notifications
            openModal('notification-modal'); // Open the notification modal
        });

        // Event listener for Add Account link
        addAccountLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdown.classList.remove('show'); // Hide dropdown
            // Check account limit before opening signup
            if (users.length < ACCOUNT_LIMIT) {
                 openModal('signup-modal');
                 signupAvatarInput.value = ''; // Clear previous avatar selection
                 renderAvatarOptions(avatarOptionsContainer, signupAvatarInput);
            } else {
                 // Optionally display a message to the user that the limit is reached
                 // This could be a temporary message or a modal
                 alert(`Account limit (${ACCOUNT_LIMIT}) reached. Cannot create more accounts.`);
            }
        });

        // Event listener for Switch Account link
        switchAccountLink.addEventListener('click', (event) => {
            event.preventDefault();
            profileDropdown.classList.remove('show'); // Hide dropdown
            renderSwitchAccountOptions(); // Populate the switch account modal
            openModal('switch-account-modal'); // Open the switch account modal
        });

        // Scroll to top button logic
        window.addEventListener('scroll', () => {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.style.display = 'flex'; // Use flex to maintain centering
            } else {
                scrollToTopBtn.style.display = 'none';
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scrolling
            });
        });

        // Event listener for the new search button
        searchButton.addEventListener('click', () => {
            searchContainer.classList.toggle('show'); // Toggle the 'show' class
             // Optional: Focus the input when the search bar is shown
             if (searchContainer.classList.contains('show')) {
                 searchInput.focus();
                 // If opening the search, check if there's text and show clear button
                 if (searchInput.value.trim() !== "") {
                     clearSearchBtn.style.display = 'inline-block';
                 }
             } else {
                 // Optional: Clear the search input when the search bar is hidden
                 searchInput.value = '';
                 clearSearchBtn.style.display = 'none'; // Hide clear button when closing
                 searchLoadingSpinner.style.display = 'none'; // Hide spinner when closing
                 performSearch(); // Re-run search with empty term to show all posts
             }
        });

        // Add touch event listeners to ALL modal header handle elements
        modalHeaderHandles.forEach(handleElement => {
             handleElement.addEventListener('touchstart', (event) => {
                 touchstartY = event.touches[0].clientY;
             });

             handleElement.addEventListener('touchend', (event) => {
                 const touchendY = event.changedTouches[0].clientY;
                 const deltaY = touchendY - touchstartY;
                 const swipeThreshold = 50; // Minimum distance for a swipe

                 // Find the parent modal element to get its ID
                 const modalElement = handleElement.closest('.modal-bottom-sheet');

                 // Close if swiping down on the handle
                 if (modalElement && deltaY > swipeThreshold) {
                     closeModal(modalElement.id);
                 }
             });
        });


        // Initial setup on page load
        window.onload = function() {
             // Always show loading overlay initially
            loadingOverlay.style.display = 'flex';
            mainContentDiv.style.display = 'none'; // Hide main content

            // Determine loading screen content based on login status
            loadUserProfile(); // This now only sets the loading screen details and header elements' visibility state

             // Set loading screen avatar and username based on loggedInUser or default
            if (loggedInUser) {
                loadingAvatarImg.src = loggedInUser.avatar;
                loadingUsernameSpan.textContent = loggedInUser.username;
            } else {
                 // Use a default avatar and text if not logged in
                 loadingAvatarImg.src = avatarImages[0]; // Or any default image
                 loadingUsernameSpan.textContent = 'Loading...';
            }


            // Hide loading screen and show main content after 3 seconds
            setTimeout(() => {
                loadingOverlay.style.opacity = '0'; // Start fade out
                setTimeout(() => {
                    loadingOverlay.style.display = 'none'; // Hide completely after fade
                    loadingOverlay.style.opacity = '1'; // Reset opacity for next load
                    mainContentDiv.style.display = 'block'; // Show main content

                     // Now that the loading is done and main content is visible,
                     // call loadUserProfile again to ensure correct header state
                     // and display initial posts.
                     loadUserProfile(); // Re-run to set header based on final loggedInUser state (this will also load the correct history and render continue watching)

                     // Initial display of main posts (filtered and shuffled)
                     displayPosts(getPostsForDisplay());

                     // Start the hourly shuffle interval for main posts (only if not searching)
                     // 3600000 milliseconds = 1 hour
                     setInterval(() => {
                         if (searchInput.value.trim() === "") {
                              shuffleAndDisplayPosts();
                         }
                     }, 3600000);

                }, 500); // Match CSS transition duration
            }, 3000); // 3 seconds delay for initial loading screen
        };

    </script>
</body>
</html>
